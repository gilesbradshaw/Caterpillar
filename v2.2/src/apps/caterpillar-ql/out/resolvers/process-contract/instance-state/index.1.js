"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _getNestedContracts = _interopRequireDefault(require("./get-nested-contracts"));

var _debug2 = _interopRequireDefault(require("debug"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const debug = (0, _debug2.default)('caterpillarql:process-contract:instance-state');

const findParameters = (contractAbi, functionName) => {
  let jsonAbi = JSON.parse(contractAbi);
  let candidates = [];
  jsonAbi.forEach(element => {
    if (element.name === functionName) {
      candidates = element.inputs;
    }
  });
  let res = [];
  candidates.forEach(element => {
    if (element.name && element.name !== 'workitemId') res.push(element);
  });
  return res;
};

var _default = ({
  web3,
  bpmnModel,
  registryContract
}) => async contractAddress => {
  debug({
    contractAddress
  });
  const nestedContracts = await (0, _getNestedContracts.default)({
    web3,
    registryContract
  })(contractAddress);
  const x = await Promise.all(nestedContracts.map(async ({
    bundleId,
    contractAddress,
    abi,
    indexToElement,
    worklistAbi,
    worklistAddress,
    worklistInstance,
    startedActivities,
    startedInstances
  }) => Promise.all(startedActivities.map(async (startedActivity, index) => {
    if (startedActivity === '1' && indexToElement[index].type === 'Workitem') {
      const reqInd = await worklistInstance.methods.workItemsFor(index, contractAddress).call().then(x => web3.utils.toBN(x).toString(2).split('').reverse());
      const ret = await Promise.all(reqInd.map(async (req, i) => {
        if (req === '1') {
          return {
            worklistAddress,
            bundleId: bundleId,
            elementId: indexToElement[index].id,
            elementName: indexToElement[index].name,
            hrefs: [`/workitems/${worklistAddress}/${i}`],
            input: findParameters(worklistAbi, indexToElement[index].name),
            pcases: [await worklistInstance.methods.processInstanceFor(i).call()],
            processAddress: contractAddress
          };
        }
      }));
      return ret;
    } // return Promise.resolve()

  }))));
  const workItems = x.reduce((acc, items) => [...acc, ...(items || [])], []).reduce((acc, items) => [...acc, ...(items || [])], []).filter(x => x).map((item, index) => _objectSpread({}, item, {
    index
  })).reduce((acc, item) => {
    const exists = acc.find(({
      elementId,
      bundleId
    }) => elementId === item.elementId && bundleId === item.bundleId);

    if (exists) {
      return [...acc.filter(a => a !== exists), _objectSpread({}, exists, {
        hrefs: [...exists.hrefs, ...item.hrefs],
        pcases: [...exists.pcases, ...item.pcases]
      })];
    }

    return [...acc, item];
  }, []).sort(({
    index
  }) => index);
  return {
    bpmn: bpmnModel,
    workItems
  };
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2FwcC9yZXNvbHZlcnMvcHJvY2Vzcy1jb250cmFjdC9pbnN0YW5jZS1zdGF0ZS9pbmRleC4xLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwiZmluZFBhcmFtZXRlcnMiLCJjb250cmFjdEFiaSIsImZ1bmN0aW9uTmFtZSIsImpzb25BYmkiLCJKU09OIiwicGFyc2UiLCJjYW5kaWRhdGVzIiwiZm9yRWFjaCIsImVsZW1lbnQiLCJuYW1lIiwiaW5wdXRzIiwicmVzIiwicHVzaCIsIndlYjMiLCJicG1uTW9kZWwiLCJyZWdpc3RyeUNvbnRyYWN0IiwiY29udHJhY3RBZGRyZXNzIiwibmVzdGVkQ29udHJhY3RzIiwieCIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJidW5kbGVJZCIsImFiaSIsImluZGV4VG9FbGVtZW50Iiwid29ya2xpc3RBYmkiLCJ3b3JrbGlzdEFkZHJlc3MiLCJ3b3JrbGlzdEluc3RhbmNlIiwic3RhcnRlZEFjdGl2aXRpZXMiLCJzdGFydGVkSW5zdGFuY2VzIiwic3RhcnRlZEFjdGl2aXR5IiwiaW5kZXgiLCJ0eXBlIiwicmVxSW5kIiwibWV0aG9kcyIsIndvcmtJdGVtc0ZvciIsImNhbGwiLCJ0aGVuIiwidXRpbHMiLCJ0b0JOIiwidG9TdHJpbmciLCJzcGxpdCIsInJldmVyc2UiLCJyZXQiLCJyZXEiLCJpIiwiZWxlbWVudElkIiwiaWQiLCJlbGVtZW50TmFtZSIsImhyZWZzIiwiaW5wdXQiLCJwY2FzZXMiLCJwcm9jZXNzSW5zdGFuY2VGb3IiLCJwcm9jZXNzQWRkcmVzcyIsIndvcmtJdGVtcyIsInJlZHVjZSIsImFjYyIsIml0ZW1zIiwiZmlsdGVyIiwiaXRlbSIsImV4aXN0cyIsImZpbmQiLCJhIiwic29ydCIsImJwbW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUFFQSxNQUFNQSxLQUFLLEdBQUcscUJBQU8sK0NBQVAsQ0FBZDs7QUFFQSxNQUFNQyxjQUFjLEdBQUcsQ0FBQ0MsV0FBRCxF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LENBREUsb0JBR0FBLE1BSEE7QUFJSFgsUUFBQUEsS0FBSyxFQUFDLENBQ0osR0FBR1csTUFBTSxDQUFDWCxLQUROLEVBRUosR0FBR1UsSUFBSSxDQUFDVixLQUZKLENBSkg7QUFRSEUsUUFBQUEsTUFBTSxFQUFFLENBQ04sR0FBR1MsTUFBTSxDQUFDVCxNQURKLEVBRU4sR0FBR1EsSUFBSSxDQUFDUixNQUZGO0FBUkwsU0FBUDtBQWNEOztBQUNELFdBQU8sQ0FDTCxHQUFHSyxHQURFLEVBRUxHLElBRkssQ0FBUDtBQUtELEdBbERhLEVBbURkLEVBbkRjLEVBcURmSSxJQXJEZSxDQXNEZCxDQUFDO0FBQUVoQyxJQUFBQTtBQUFGLEdBQUQsS0FBZUEsS0F0REQsQ0FBbEI7QUF3REEsU0FBTztBQUNMaUMsSUFBQUEsSUFBSSxFQUFFbEQsU0FERDtBQUVMd0MsSUFBQUE7QUFGSyxHQUFQO0FBSUQsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBXZWIzIGZyb20gJ3dlYjMnXG5pbXBvcnQgZ2V0TmVzdGVkQ29udHJhY3RzIGZyb20gJy4vZ2V0LW5lc3RlZC1jb250cmFjdHMnXG5pbXBvcnQgX2RlYnVnIGZyb20gJ2RlYnVnJ1xuXG5jb25zdCBkZWJ1ZyA9IF9kZWJ1ZygnY2F0ZXJwaWxsYXJxbDpwcm9jZXNzLWNvbnRyYWN0Omluc3RhbmNlLXN0YXRlJylcblxuY29uc3QgZmluZFBhcmFtZXRlcnMgPSAoY29udHJhY3RBYmksIGZ1bmN0aW9uTmFtZSkgPT4ge1xuICBsZXQganNvbkFiaSA9IEpTT04ucGFyc2UoY29udHJhY3RBYmkpO1xuICBsZXQgY2FuZGlkYXRlcyA9IFtdO1xuICBqc29uQWJpLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICBpZiAoZWxlbWVudC5uYW1lID09PSBmdW5jdGlvbk5hbWUpIHtcbiAgICAgICAgICBjYW5kaWRhdGVzID0gZWxlbWVudC5pbnB1dHM7XG4gICAgICB9XG4gIH0pO1xuICBsZXQgcmVzID0gW107XG4gIGNhbmRpZGF0ZXMuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgIGlmIChlbGVtZW50Lm5hbWUgJiYgZWxlbWVudC5uYW1lICE9PSAnd29ya2l0ZW1JZCcpXG4gICAgICAgICAgcmVzLnB1c2goZWxlbWVudCk7XG4gIH0pO1xuICByZXR1cm4gcmVzO1xufTtcblxuXG5leHBvcnQgZGVmYXVsdCAoXG4gIHtcbiAgICB3ZWIzLFxuICAgIGJwbW5Nb2RlbCxcbiAgICByZWdpc3RyeUNvbnRyYWN0LFxuICB9IDoge1xuICAgIHdlYjM6IFdlYjMsXG4gICAgYnBtbk1vZGVsOiBzdHJpbmcsXG4gICAgcmVnaXN0cnlDb250cmFjdDogaW1wb3J0KCdjYXRlcnBpbGxhci1saWInKS5SZWdpc3RyeUNvbnRyYWN0LFxuICB9XG4pOiBGdW5jdGlvbiA9PiBhc3luYyAoXG4gIGNvbnRyYWN0QWRkcmVzcyxcbik6IFByb21pc2U8YW55PiA9PiB7XG4gIGRlYnVnKHsgY29udHJhY3RBZGRyZXNzIH0pXG4gIGNvbnN0IG5lc3RlZENvbnRyYWN0cyA9IGF3YWl0IGdldE5lc3RlZENvbnRyYWN0cyh7XG4gICAgd2ViMyxcbiAgICByZWdpc3RyeUNvbnRyYWN0LCAgXG4gIH0pKGNvbnRyYWN0QWRkcmVzcylcblxuICBjb25zdCB4ID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgbmVzdGVkQ29udHJhY3RzXG4gICAgICAubWFwKFxuICAgICAgICBhc3luYyAoe1xuICAgICAgICAgIGJ1bmRsZUlkLFxuICAgICAgICAgIGNvbnRyYWN0QWRkcmVzcyxcbiAgICAgICAgICBhYmksXG4gICAgICAgICAgaW5kZXhUb0VsZW1lbnQsXG4gICAgICAgICAgd29ya2xpc3RBYmksXG4gICAgICAgICAgd29ya2xpc3RBZGRyZXNzLFxuICAgICAgICAgIHdvcmtsaXN0SW5zdGFuY2UsXG4gICAgICAgICAgc3RhcnRlZEFjdGl2aXRpZXMsXG4gICAgICAgICAgc3RhcnRlZEluc3RhbmNlcyxcbiAgICAgICAgfSk6IFByb21pc2U8YW55PiA9PiBQcm9taXNlLmFsbChcbiAgICAgICAgICBzdGFydGVkQWN0aXZpdGllc1xuICAgICAgICAgICAgLm1hcChcbiAgICAgICAgICAgICAgYXN5bmMgKFxuICAgICAgICAgICAgICAgIHN0YXJ0ZWRBY3Rpdml0eSxcbiAgICAgICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgICAgKTogUHJvbWlzZTxhbnk+ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhcnRlZEFjdGl2aXR5ID09PSAnMScgJiYgaW5kZXhUb0VsZW1lbnRbaW5kZXhdLnR5cGUgPT09ICdXb3JraXRlbScpIHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcUluZCA9IGF3YWl0IHdvcmtsaXN0SW5zdGFuY2UubWV0aG9kcy53b3JrSXRlbXNGb3IoaW5kZXgsIGNvbnRyYWN0QWRkcmVzcykuY2FsbCgpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKFxuICAgICAgICAgICAgICAgICAgICAgICh4KTogYW55ID0+XG4gICAgICAgICAgICAgICAgICAgICAgICB3ZWIzLnV0aWxzLnRvQk4oeCkudG9TdHJpbmcoMikuc3BsaXQoJycpLnJldmVyc2UoKSxcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICBjb25zdCByZXQgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgICAgICAgICAgICAgcmVxSW5kXG4gICAgICAgICAgICAgICAgICAgICAgLm1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzeW5jIChyZXEsIGkpOiBQcm9taXNlPGFueT4gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVxID09PSAnMScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya2xpc3RBZGRyZXNzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVuZGxlSWQ6IGJ1bmRsZUlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudElkOiBpbmRleFRvRWxlbWVudFtpbmRleF0uaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50TmFtZTogaW5kZXhUb0VsZW1lbnRbaW5kZXhdLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBocmVmczogW2Avd29ya2l0ZW1zLyR7d29ya2xpc3RBZGRyZXNzfS8ke2l9YF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dDogZmluZFBhcmFtZXRlcnMod29ya2xpc3RBYmksIGluZGV4VG9FbGVtZW50W2luZGV4XS5uYW1lKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBjYXNlczogWyBhd2FpdCB3b3JrbGlzdEluc3RhbmNlLm1ldGhvZHMucHJvY2Vzc0luc3RhbmNlRm9yKGkpLmNhbGwoKV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzQWRkcmVzczogY29udHJhY3RBZGRyZXNzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgIHJldHVybiByZXRcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIClcbiAgICAgICAgKSxcbiAgICAgIClcbiAgKVxuICBjb25zdCB3b3JrSXRlbXMgPSB4XG4gICAgLnJlZHVjZShcbiAgICAgIChhY2MsIGl0ZW1zKSA9PiBbXG4gICAgICAgIC4uLmFjYyxcbiAgICAgICAgLi4uaXRlbXMgfHwgW10sXG4gICAgICBdLFxuICAgICAgW10sXG4gICAgKVxuICAgIC5yZWR1Y2UoXG4gICAgICAoYWNjLCBpdGVtcykgPT4gW1xuICAgICAgICAuLi5hY2MsXG4gICAgICAgIC4uLml0ZW1zIHx8IFtdLFxuICAgICAgXSxcbiAgICAgIFtdLFxuICAgIClcbiAgICAuZmlsdGVyKHggPT4geClcbiAgICAubWFwKFxuICAgICAgKGl0ZW0sIGluZGV4KSA9PiAoe1xuICAgICAgICAuLi5pdGVtLFxuICAgICAgICBpbmRleCxcbiAgICAgIH0pXG4gICAgKVxuICAgIC5yZWR1Y2UoXG4gICAgICAoYWNjLCBpdGVtKSA9PiB7XG4gICAgICAgIGNvbnN0IGV4aXN0cyA9IGFjYy5maW5kKFxuICAgICAgICAgICh7IGVsZW1lbnRJZCwgYnVuZGxlSWQgfSkgPT5cbiAgICAgICAgICAgIGVsZW1lbnRJZCA9PT0gaXRlbS5lbGVtZW50SWQgJiZcbiAgICAgICAgICAgICAgYnVuZGxlSWQgPT09IGl0ZW0uYnVuZGxlSWQsXG4gICAgICAgIClcbiAgICAgICAgaWYgKGV4aXN0cykge1xuICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAuLi5hY2MuZmlsdGVyKGEgPT4gYSAhPT0gZXhpc3RzKSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgLi4uZXhpc3RzLFxuICAgICAgICAgICAgICBocmVmczpbXG4gICAgICAgICAgICAgICAgLi4uZXhpc3RzLmhyZWZzLFxuICAgICAgICAgICAgICAgIC4uLml0ZW0uaHJlZnMsXG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgIHBjYXNlczogW1xuICAgICAgICAgICAgICAgIC4uLmV4aXN0cy5wY2FzZXMsXG4gICAgICAgICAgICAgICAgLi4uaXRlbS5wY2FzZXMsXG4gICAgICAgICAgICAgIF1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAuLi5hY2MsXG4gICAgICAgICAgaXRlbSxcbiAgICAgICAgXSAgXG4gICAgICAgIFxuICAgICAgfSxcbiAgICAgIFtdLFxuICAgIClcbiAgICAuc29ydChcbiAgICAgICh7IGluZGV4IH0pID0+IGluZGV4LFxuICAgIClcbiAgcmV0dXJuIHtcbiAgICBicG1uOiBicG1uTW9kZWwsXG4gICAgd29ya0l0ZW1zLFxuICB9XG59XG4iXX0=