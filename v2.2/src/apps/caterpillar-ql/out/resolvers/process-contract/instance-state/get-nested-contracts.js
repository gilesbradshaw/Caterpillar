"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _repo = require("../../repo");

const nestedContracts = ({
  web3,
  registryContract
}) => async contractAddress => {
  const bundleId = await registryContract.bundleFor({
    instance: contractAddress
  });
  const [{
    abi,
    indexToElement,
    worklistAbi
  }] = await _repo.process.find({
    _id: bundleId
  }); // shouldnt need this...

  if (!abi || !worklistAbi) {
    return [];
  }

  const contractInstance = new web3.eth.Contract(JSON.parse(abi), contractAddress);
  contractInstance.transactionConfirmationBlocks = 1;
  const worklistAddress = await contractInstance.methods.getWorklistAddress.call();
  const worklistInstance = worklistAddress.toString() !== '0x0000000000000000000000000000000000000000' && new web3.eth.Contract(JSON.parse(worklistAbi), worklistAddress);

  if (worklistInstance) {
    worklistInstance.transactionConfirmationBlocks = 1;
  }

  const startedActivities = web3.utils.toBN((await contractInstance.methods.startedActivities.call())).toString(2).split('').reverse();
  const startedInstances = await Promise.all(startedActivities.map((activityState, index) => activityState === '1' && indexToElement[index].type).map((type, index) => {
    if (type !== 'Separate-Instance') {
      return Promise.resolve([]);
    }

    return contractInstance.methods.startedInstanceIndexFor(index).call().then(x => web3.utils.toBN(x).toString(2).split('').reverse()).then(startedInstances => contractInstance.methods.allInstanceAddresses.call().then(allInstances => startedInstances.map((startedInstance, index) => startedInstance === '1' && allInstances[index]).filter(instance => instance)));
  }));
  const instanceStates = await Promise.all(startedInstances.reduce((acc, instances) => [...acc, ...instances], []).map(state => nestedContracts({
    web3,
    registryContract
  })(state)));
  return instanceStates.reduce((acc, instances) => [...acc, ...instances], [{
    bundleId,
    contractAddress,
    abi,
    indexToElement,
    worklistAbi,
    worklistAddress,
    worklistInstance,
    startedActivities,
    startedInstances
  }]);
};

var _default = nestedContracts;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2FwcC9yZXNvbHZlcnMvcHJvY2Vzcy1jb250cmFjdC9pbnN0YW5jZS1zdGF0ZS9nZXQtbmVzdGVkLWNvbnRyYWN0cy50cyJdLCJuYW1lcyI6WyJuZXN0ZWRDb250cmFjdHMiLCJ3ZWIzIiwicmVnaXN0cnlDb250cmFjdCIsImNvbnRyYWN0QWRkcmVzcyIsImJ1bmRsZUlkIiwiYnVuZGxlRm9yIiwiaW5zdGFuY2UiLCJhYmkiLCJpbmRleFRvRWxlbWVudCIsIndvcmtsaXN0QWJpIiwicHJvY2VzcyIsImZpbmQiLCJfaWQiLCJjb250cmFjdEluc3RhbmNlIiwiZXRoIiwiQ29udHJhY3QiLCJKU09OIiwicGFyc2UiLCJ0cmFuc2FjdGlvbkNvbmZpcm1hdGlvbkJsb2NrcyIsIndvcmtsaXN0QWRkcmVzcyIsIm1ldGhvZHMiLCJnZXRXb3JrbGlzdEFkZHJlc3MiLCJjYWxsIiwid29ya2xpc3RJbnN0YW5jZSIsInRvU3RyaW5nIiwic3RhcnRlZEFjdGl2aXRpZXMiLCJ1dGlscyIsInRvQk4iLCJzcGxpdCIsInJldmVyc2UiLCJzdGFydGVkSW5zdGFuY2VzIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsImFjdGl2aXR5U3RhdGUiLCJpbmRleCIsInR5cGUiLCJyZXNvbHZlIiwic3RhcnRlZEluc3RhbmNlSW5kZXhGb3IiLCJ0aGVuIiwieCIsImFsbEluc3RhbmNlQWRkcmVzc2VzIiwiYWxsSW5zdGFuY2VzIiwic3RhcnRlZEluc3RhbmNlIiwiZmlsdGVyIiwiaW5zdGFuY2VTdGF0ZXMiLCJyZWR1Y2UiLCJhY2MiLCJpbnN0YW5jZXMiLCJzdGF0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUtBLE1BQU1BLGVBQWUsR0FBRyxDQUN0QjtBQUNFQyxFQUFBQSxJQURGO0FBRUVDLEVBQUFBO0FBRkYsQ0FEc0IsS0FRVCxNQUNiQyxlQURhLElBRU07QUFDbkIsUUFBTUMsUUFBUSxHQUFHLE1BQU1GLGdCQUFnQixDQUNwQ0csU0FEb0IsQ0FDVjtB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QyxFQUVoRCxHQUFHQyxTQUY2QyxDQUZ0RCxFQU1JLEVBTkosRUFRR2YsR0FSSCxDQVNLZ0IsS0FBRCxJQUFnQmpELGVBQWUsQ0FBQztBQUM5QkMsSUFBQUEsSUFEOEI7QUFFOUJDLElBQUFBO0FBRjhCLEdBQUQsQ0FBZixDQUdiK0MsS0FIYSxDQVRwQixDQUQyQixDQUE3QjtBQWlCQSxTQUFPSixjQUFjLENBQ2xCQyxNQURJLENBRUgsQ0FBQ0MsR0FBRCxFQUFhQyxTQUFiLEtBQWtDLENBQ2hDLEdBQUdELEdBRDZCLEVBRWhDLEdBQUdDLFNBRjZCLENBRi9CLEVBTUgsQ0FBQztBQUNDNUMsSUFBQUEsUUFERDtBQUVDRCxJQUFBQSxlQUZEO0FBR0NJLElBQUFBLEdBSEQ7QUFJQ0MsSUFBQUEsY0FKRDtBQUtDQyxJQUFBQSxXQUxEO0FBTUNVLElBQUFBLGVBTkQ7QUFPQ0ksSUFBQUEsZ0JBUEQ7QUFRQ0UsSUFBQUEsaUJBUkQ7QUFTQ0ssSUFBQUE7QUFURCxHQUFELENBTkcsQ0FBUDtBQW1CRCxDQTVHRDs7ZUE4R2U5QixlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcHJvY2VzcyB9IGZyb20gJy4uLy4uL3JlcG8nXG5pbXBvcnQgaGV4VG9JZCBmcm9tICcuLi8uLi91dGlsL2hleC10by1pZCdcbmltcG9ydCBXZWIzIGZyb20gJ3dlYjMnO1xuXG5cbmNvbnN0IG5lc3RlZENvbnRyYWN0cyA9IChcbiAge1xuICAgIHdlYjMsXG4gICAgcmVnaXN0cnlDb250cmFjdCxcbiAgfToge1xuICAgIHdlYjM6IFdlYjMsXG4gICAgcmVnaXN0cnlDb250cmFjdDogaW1wb3J0KCdjYXRlcnBpbGxhci1saWInKS5SZWdpc3RyeUNvbnRyYWN0XG4gIH1cbik6IEZ1bmN0aW9uID0+IGFzeW5jIChcbiAgY29udHJhY3RBZGRyZXNzLFxuKTogUHJvbWlzZTxhbnlbXT4gPT4ge1xuICBjb25zdCBidW5kbGVJZCA9IGF3YWl0IHJlZ2lzdHJ5Q29udHJhY3RcbiAgICAuYnVuZGxlRm9yKHsgaW5zdGFuY2U6IGNvbnRyYWN0QWRkcmVzcyB9KVxuICBjb25zdCBbe1xuICAgIGFiaSxcbiAgICBpbmRleFRvRWxlbWVudCxcbiAgICB3b3JrbGlzdEFiaSxcbiAgfV0gPSBhd2FpdCBwcm9jZXNzXG4gICAgLmZpbmQoeyBfaWQ6IGJ1bmRsZUlkIH0pXG4gIC8vIHNob3VsZG50IG5lZWQgdGhpcy4uLlxuICBpZiAoIWFiaSB8fCAhd29ya2xpc3RBYmkpIHtcbiAgICByZXR1cm4gW11cbiAgfVxuICBjb25zdCBjb250cmFjdEluc3RhbmNlID0gbmV3IHdlYjMuZXRoLkNvbnRyYWN0KEpTT04ucGFyc2UoYWJpKSwgY29udHJhY3RBZGRyZXNzKVxuICBjb250cmFjdEluc3RhbmNlLnRyYW5zYWN0aW9uQ29uZmlybWF0aW9uQmxvY2tzID0gMTtcblxuICBjb25zdCB3b3JrbGlzdEFkZHJlc3MgPSBhd2FpdCBjb250cmFjdEluc3RhbmNlLm1ldGhvZHMuZ2V0V29ya2xpc3RBZGRyZXNzLmNhbGwoKVxuICBjb25zdCB3b3JrbGlzdEluc3RhbmNlID0gd29ya2xpc3RBZGRyZXNzLnRvU3RyaW5nKCkgIT09ICcweDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAnICYmXG4gICAgbmV3IHdlYjMuZXRoLkNvbnRyYWN0KEpTT04ucGFyc2Uod29ya2xpc3RBYmkpLCB3b3JrbGlzdEFkZHJlc3MpXG4gIGlmICh3b3JrbGlzdEluc3RhbmNlKSB7XG4gICAgd29ya2xpc3RJbnN0YW5jZS50cmFuc2FjdGlvbkNvbmZpcm1hdGlvbkJsb2NrcyA9IDE7XG4gIH1cbiAgY29uc3Qgc3RhcnRlZEFjdGl2aXRpZXMgPSB3ZWIzLnV0aWxzLnRvQk4oXG4gICAgYXdhaXQgY29udHJhY3RJbnN0YW5jZVxuICAgICAgLm1ldGhvZHNcbiAgICAgIC5zdGFydGVkQWN0aXZpdGllc1xuICAgICAgLmNhbGwoKVxuICApLnRvU3RyaW5nKDIpLnNwbGl0KCcnKS5yZXZlcnNlKClcbiAgY29uc3Qgc3RhcnRlZEluc3RhbmNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgIHN0YXJ0ZWRBY3Rpdml0aWVzXG4gICAgICAubWFwKFxuICAgICAgICAoYWN0aXZpdHlTdGF0ZSwgaW5kZXgpOiBzdHJpbmcgPT4gYWN0aXZpdHlTdGF0ZSA9PT0gJzEnICYmXG4gICAgICAgICAgaW5kZXhUb0VsZW1lbnRbaW5kZXhdLnR5cGUsXG4gICAgICApXG4gICAgICAubWFwKFxuICAgICAgICAodHlwZSwgaW5kZXgpOiBQcm9taXNlPGFueVtdPiA9PiB7XG4gICAgICAgICAgaWYgKHR5cGUgIT09ICdTZXBhcmF0ZS1JbnN0YW5jZScpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBjb250cmFjdEluc3RhbmNlLm1ldGhvZHMuc3RhcnRlZEluc3RhbmNlSW5kZXhGb3IoaW5kZXgpLmNhbGwoKVxuICAgICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICAgICh4KTogYW55ID0+XG4gICAgICAgICAgICAgICAgd2ViMy51dGlscy50b0JOKHgpLnRvU3RyaW5nKDIpLnNwbGl0KCcnKS5yZXZlcnNlKCksXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAudGhlbihcbiAgICAgICAgICAgICAgKHN0YXJ0ZWRJbnN0YW5jZXMpOiBzdHJpbmdbXSA9PlxuICAgICAgICAgICAgICAgIGNvbnRyYWN0SW5zdGFuY2UubWV0aG9kcy5hbGxJbnN0YW5jZUFkZHJlc3Nlcy5jYWxsKClcbiAgICAgICAgICAgICAgICAgIC50aGVuKFxuICAgICAgICAgICAgICAgICAgICAoYWxsSW5zdGFuY2VzKTogc3RyaW5nID0+XG4gICAgICAgICAgICAgICAgICAgICAgc3RhcnRlZEluc3RhbmNlc1xuICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKHN0YXJ0ZWRJbnN0YW5jZSwgaW5kZXgpOiBzdHJpbmcgPT4gc3RhcnRlZEluc3RhbmNlID09PSAnMScgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxJbnN0YW5jZXNbaW5kZXhdXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoaW5zdGFuY2UpOiBzdHJpbmcgPT4gaW5zdGFuY2VcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgfVxuICAgICAgKVxuICApXG4gIGNvbnN0IGluc3RhbmNlU3RhdGVzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgc3RhcnRlZEluc3RhbmNlc1xuICAgICAgLnJlZHVjZTxzdHJpbmdbXT4oXG4gICAgICAgIChhY2M6IHN0cmluZ1tdLCBpbnN0YW5jZXM6IHN0cmluZ1tdKTogc3RyaW5nW10gPT4gW1xuICAgICAgICAgIC4uLmFjYyxcbiAgICAgICAgICAuLi5pbnN0YW5jZXMsXG4gICAgICAgIF0sXG4gICAgICAgIFtdLFxuICAgICAgKVxuICAgICAgLm1hcChcbiAgICAgICAgKHN0YXRlKTogYW55ID0+IG5lc3RlZENvbnRyYWN0cyh7XG4gICAgICAgICAgd2ViMyxcbiAgICAgICAgICByZWdpc3RyeUNvbnRyYWN0LFxuICAgICAgICB9KShzdGF0ZSlcbiAgICAgIClcbiAgKVxuXG4gIHJldHVybiBpbnN0YW5jZVN0YXRlc1xuICAgIC5yZWR1Y2U8YW55W10+KFxuICAgICAgKGFjYzogYW55W10sIGluc3RhbmNlcyk6IGFueVtdID0+IFtcbiAgICAgICAgLi4uYWNjLFxuICAgICAgICAuLi5pbnN0YW5jZXMsXG4gICAgICBdLFxuICAgICAgW3tcbiAgICAgICAgYnVuZGxlSWQsXG4gICAgICAgIGNvbnRyYWN0QWRkcmVzcyxcbiAgICAgICAgYWJpLFxuICAgICAgICBpbmRleFRvRWxlbWVudCxcbiAgICAgICAgd29ya2xpc3RBYmksXG4gICAgICAgIHdvcmtsaXN0QWRkcmVzcyxcbiAgICAgICAgd29ya2xpc3RJbnN0YW5jZSxcbiAgICAgICAgc3RhcnRlZEFjdGl2aXRpZXMsXG4gICAgICAgIHN0YXJ0ZWRJbnN0YW5jZXMsXG4gICAgICB9XSxcbiAgICApXG4gICAgXG59XG5cbmV4cG9ydCBkZWZhdWx0IG5lc3RlZENvbnRyYWN0c1xuIl19