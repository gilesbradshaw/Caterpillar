"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.BindingVisitor = void 0;

var _Decorators = require("antlr4ts/Decorators");

var _DataStructures = require("./DataStructures");

var _class, _temp;

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _applyDecoratedDescriptor(target, property, decorators, descriptor, context) { var desc = {}; Object.keys(descriptor).forEach(function (key) { desc[key] = descriptor[key]; }); desc.enumerable = !!desc.enumerable; desc.configurable = !!desc.configurable; if ('value' in desc || desc.initializer) { desc.writable = true; } desc = decorators.slice().reverse().reduce(function (desc, decorator) { return decorator(target, property, desc) || desc; }, desc); if (context && desc.initializer !== void 0) { desc.value = desc.initializer ? desc.initializer.call(context) : void 0; desc.initializer = undefined; } if (desc.initializer === void 0) { Object.defineProperty(target, property, desc); desc = null; } return desc; }

let BindingVisitor = (_class = (_temp = class BindingVisitor {
  constructor() {
    _defineProperty(this, "_names", []);

    _defineProperty(this, "policy", new _DataStructures.Policy());
  }

  defaultResult() {
    return "";
  }

  updateRules(names) {
    this._names = names;
  }

  visitTerminal(node) {
    let res = node.toStringTree();
    if (res === 'and') return '&';else if (res === 'or') return '|';else return res;
  }

  visitErrorNode(node) {
    let res = node.toStringTree();
    return res;
  }

  visit(tree) {
    return tree.accept(this);
  }

  visitUnbinding_statement(ctx) {
    let statement = new _DataStructures.Statement();
    statement.nominator = ctx.nominator().accept(this);
    statement.nominee = ctx.nominee().accept(this);
    if (ctx.binding_constr() !== undefined) statement.bindingConstraint = this.createDisjunctionSet(ctx.binding_constr().accept(this));
    if (ctx.endorsement_constr() !== undefined) statement.endorsementConstraint = this.createDisjunctionSet(ctx.endorsement_constr().accept(this));
    this.policy.addReleaseStatement(statement);
    return '';
  }

  visitBinding_statement(ctx) {
    if (ctx.is_creator() !== undefined) {
      let creator = ctx.is_creator().accept(this);
      this.policy.setCreator(creator);
    } else {
      let statement = new _DataStructures.Statement();
      statement.nominator = ctx.nominator().accept(this);
      statement.nominee = ctx.nominee().accept(this);
      if (ctx.binding_constr() !== undefined) statement.bindingConstraint = this.createDisjunctionSet(ctx.binding_constr().accept(this));
      if (ctx.endorsement_constr() !== undefined) statement.endorsementConstraint = this.createDisjunctionSet(ctx.endorsement_constr().accept(this));
      this.policy.addNominationStatement(statement);
    }

    return '';
  }

  visitIs_creator(ctx) {
    return ctx.role().text;
  }

  visitNominator(ctx) {
    this.policy.addRole(ctx.text);
    return ctx.text;
  }

  visitNominee(ctx) {
    this.policy.addRole(ctx.text);
    return ctx.text;
  }

  visitRole(ctx) {
    this.policy.addRole(ctx.text);
    return ctx.text;
  }

  visitBinding_constr(ctx) {
    let neg = ctx.NOT() === undefined ? '+' : '-';
    return neg + ctx.set_expresion().accept(this);
  }

  visitEndorsement_constr(ctx) {
    return '+' + ctx.set_expresion().accept(this);
  }

  visitSet_expresion(ctx) {
    let exp = '';

    for (let i = 0; i < ctx.childCount; i++) exp += ctx.getChild(i).accept(this);

    return exp;
  }

  visitChildren(node) {
    let nodeName = this._names[node.ruleContext.ruleIndex];
    let res = '';

    for (let i = 0; i < node.childCount; i++) res += node.getChild(i).accept(this);

    return res;
  }

  createDisjunctionSet(setStr) {
    let disjunctionSet = new _DataStructures.DisjunctionSet();
    disjunctionSet.isNegative = setStr[0] === '+' ? false : true;
    let conjS = setStr.substr(1).split('|');
    conjS.forEach(value => {
      let conjuntionSet = new _DataStructures.ConjunctionSet();
      conjuntionSet.roles = value.split('&');
      disjunctionSet.conjunctionSets.push(conjuntionSet);
    });
    return disjunctionSet;
  }

}, _temp), (_applyDecoratedDescriptor(_class.prototype, "visitTerminal", [_Decorators.Override], Object.getOwnPropertyDescriptor(_class.prototype, "visitTerminal"), _class.prototype), _applyDecoratedDescriptor(_class.prototype, "visitErrorNode", [_Decorators.Override], Object.getOwnPropertyDescriptor(_class.prototype, "visitErrorNode"), _class.prototype)), _class);
exports.BindingVisitor = BindingVisitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2FwcC9yZXNvbHZlcnMvbXV0YXRpb24vcG9saWN5L2R5bmFtaWNfYmluZGluZy92YWxpZGF0aW9uX2NvZGVfZ2VuL0JpbmRpbmdQb2xpY3lQYXJzZXIudHMiXSwibmFtZXMiOlsiQmluZGluZ1Zpc2l0b3IiLCJQb2xpY3kiLCJkZWZhdWx0UmVzdWx0IiwidXBkYXRlUnVsZXMiLCJuYW1lcyIsIl9uYW1lcyIsInZpc2l0VGVybWluYWwiLCJub2RlIiwicmVzIiwidG9TdHJpbmdUcmVlIiwidmlzaXRFcnJvck5vZGUiLCJ2aXNpdCIsInRyZWUiLCJhY2NlcHQiLCJ2aXNpdFVuYmluZGluZ19zdGF0ZW1lbnQiLCJjdHgiLCJzdGF0ZW1lbnQiLCJTdGF0ZW1lbnQiLCJub21pbmF0b3IiLCJub21pbmVlIiwiYmluZGluZ19jb25zdHIiLCJ1bmRlZmluZWQiLCJiaW5kaW5nQ29uc3RyYWludCIsImNyZWF0ZURpc2p1bmN0aW9uU2V0IiwiZW5kb3JzZW1lbnRfY29uc3RyIiwiZW5kb3JzZW1lbnRDb25zdHJhaW50IiwicG9saWN5IiwiYWRkUmVsZWFzZVN0YXRlbWVudCIsInZpc2l0QmluZGluZ19zdGF0ZW1lbnQiLCJpc19jcmVhdG9yIiwiY3JlYXRvciIsInNldENyZWF0b3IiLCJhZGROb21pbmF0aW9uU3RhdGVtZW50IiwidmlzaXRJc19jcmVhdG9yIiwicm9sZSIsInRleHQiLCJ2aXNpdE5vbWluYXRvciIsImFkZFJvbGUiLCJ2aXNpdE5vbWluZWUiLCJ2aXNpdFJvbGUiLCJ2aXNpdEJpbmRpbmdfY29uc3RyIiwibmVnIiwiTk9UIiwic2V0X2V4cHJlc2lvbiIsInZpc2l0RW5kb3JzZW1lbnRfY29uc3RyIiwidmlzaXRTZXRfZXhwcmVzaW9uIiwiZXhwIiwiaSIsImNoaWxkQ291bnQiLCJnZXRDaGlsZCIsInZpc2l0Q2hpbGRyZW4iLCJub2RlTmFtZSIsInJ1bGVDb250ZXh0IiwicnVsZUluZGV4Iiwic2V0U3RyIiwiZGlzanVuY3Rpb25TZXQiLCJEaXNqdW5jdGlvblNldCIsImlzTmVnYXRpdmUiLCJjb25qUyIsInN1YnN0ciIsInNwbGl0IiwiZm9yRWFjaCIsInZhbHVlIiwiY29uanVudGlvblNldCIsIkNvbmp1bmN0aW9uU2V0Iiwicm9sZXMiLCJjb25qdW5jdGlvblNldHMiLCJwdXNoIiwiT3ZlcnJpZGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFRQTs7QUFFQTs7Ozs7Ozs7SUFvQmFBLGMsc0JBQU4sTUFBTUEsY0FBTixDQUErRDtBQUFBO0FBQUEsb0NBRS9DLEVBRitDOztBQUFBLG9DQUdqRCxJQUFJQyxzQkFBSixFQUhpRDtBQUFBOztBQUt4REMsRUFBQUEsYUFBVixHQUFrQztBQUM5QixXQUFPLEVBQVA7QUFDSDs7QUFFREMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWtCO0FBQ3pCLFNBQUtDLE1BQUwsR0FBY0QsS0FBZDtBQUNIOztBQUdERSxFQUFBQSxhQURBLENBQ2NDLElBRGQsRUFDa0M7QUFDOUIsUUFBSUMsR0FBRyxHQUFHRCxJQUFJLENBQUNFLFlBQUwsRUFBVjtBQUNBLFFBQUdELEdBQUcsS0FBSyxLQUFYLEVBQ0ksT0FBTyxHQUFQLENBREosS0FFSyxJQUFHQSxHQUFHLEtBQUssSUFBWCxFQUNELE9BQU8sR0FBUCxDQURDLEtBR0QsT0FBT0EsR0FBUDtBQUNQOztBQUdERSxFQUFBQSxjQURBLENBQ2VILElBRGYsRUFDZ0M7QUFDNUIsUUFBSUMsR0FBRyxHQUFHRCxJQUFJLENBQUNFLFlBQUwsRUFBVjtBQUNBLFdBQU9ELEdBQVA7QUFDSDs7QUFFREcsRUFBQUEsS0FBSyxDQUFDQyxJQUFELEVBQWtCO0FBQ25CLFdBQU9BLElBQUksQ0FBQ0MsTUFBTCxDQUFZLElBQVosQ0FBUDtBQUNIOztBQUNEQyxFQUFBQSx3QkFBd0IsQ0FBQ0MsR0FBRCxFQUEyQztBQUMvRCxRQUFJQyxTQUFTLEdBQUcsSUFBSUMseUJBQUosRUFBaEI7QUFDQUQsSUFBQUEsU0FBUyxDQUFDRSxTQUFWLEdBQXNCSCxHQUFHLENBQUNH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QWQsR0FBb0IsS0FBcEIsR0FBNEIsSUFBeEQ7QUFDQSxRQUFJSSxLQUFLLEdBQUdKLE1BQU0sQ0FBQ0ssTUFBUCxDQUFjLENBQWQsRUFBaUJDLEtBQWpCLENBQXVCLEdBQXZCLENBQVo7QUFDQUYsSUFBQUEsS0FBSyxDQUFDRyxPQUFOLENBQWNDLEtBQUssSUFBSTtBQUNuQixVQUFJQyxhQUFhLEdBQUcsSUFBSUMsOEJBQUosRUFBcEI7QUFDQUQsTUFBQUEsYUFBYSxDQUFDRSxLQUFkLEdBQXNCSCxLQUFLLENBQUNGLEtBQU4sQ0FBWSxHQUFaLENBQXRCO0FBQ0FMLE1BQUFBLGNBQWMsQ0FBQ1csZUFBZixDQUErQkMsSUFBL0IsQ0FBb0NKLGFBQXBDO0FBQ0gsS0FKRDtBQUtBLFdBQU9SLGNBQVA7QUFDSDs7QUE1R2lFLEMseUVBYWpFYSxvQix5SkFXQUEsb0IiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7YmluZGluZ19ncmFtbWFyVmlzaXRvcn0gZnJvbSAnLi4vYW50bHIvYmluZGluZ19ncmFtbWFyVmlzaXRvcic7XG5cbmltcG9ydCB7IFBhcnNlVHJlZSB9IGZyb20gJ2FudGxyNHRzL3RyZWUvUGFyc2VUcmVlJztcbmltcG9ydCB7IFJ1bGVOb2RlIH0gZnJvbSAnYW50bHI0dHMvdHJlZS9SdWxlTm9kZSc7XG5pbXBvcnQgeyBUZXJtaW5hbE5vZGUgfSBmcm9tICdhbnRscjR0cy90cmVlL1Rlcm1pbmFsTm9kZSc7XG5pbXBvcnQgeyBFcnJvck5vZGUgfSBmcm9tICdhbnRscjR0cy90cmVlL0Vycm9yTm9kZSc7XG5cbmltcG9ydCB7IE92ZXJyaWRlIH0gZnJvbSAnYW50bHI0dHMvRGVjb3JhdG9ycyc7XG5cbmltcG9ydCB7IFxuICAgIFBvbGljeSxcbiAgICBTdGF0ZW1lbnQsXG4gICAgRGlzanVuY3Rpb25TZXQsXG4gICAgQ29uanVuY3Rpb25TZXRcbiB9IGZyb20gJy4vRGF0YVN0cnVjdHVyZXMnO1xuIFxuaW1wb3J0IHsgXG4gICAgQmluZGluZ19zdGF0ZW1lbnRDb250ZXh0LCBcbiAgICBOb21pbmF0b3JDb250ZXh0LCBcbiAgICBOb21pbmVlQ29udGV4dCwgXG4gICAgSXNfY3JlYXRvckNvbnRleHQsIFxuICAgIEJpbmRpbmdfY29uc3RyQ29udGV4dCwgXG4gICAgU2V0X2V4cHJlc2lvbkNvbnRleHQsIFxuICAgIFJvbGVDb250ZXh0LCBcbiAgICBFbmRvcnNlbWVudF9jb25zdHJDb250ZXh0LCBcbiAgICBVbmJpbmRpbmdfc3RhdGVtZW50Q29udGV4dCBcbn0gZnJvbSAnLi4vYW50bHIvYmluZGluZ19ncmFtbWFyUGFyc2VyJztcblxuIFxuZXhwb3J0IGNsYXNzIEJpbmRpbmdWaXNpdG9yIGltcGxlbWVudHMgYmluZGluZ19ncmFtbWFyVmlzaXRvcjxzdHJpbmc+IHtcblxuICAgIF9uYW1lczogc3RyaW5nW10gPSBbXTtcbiAgICBwb2xpY3k6IFBvbGljeSA9IG5ldyBQb2xpY3koKTtcbiAgIFxuICAgIHByb3RlY3RlZCBkZWZhdWx0UmVzdWx0KCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBcIlwiO1xuICAgIH1cblxuICAgIHVwZGF0ZVJ1bGVzKG5hbWVzOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLl9uYW1lcyA9IG5hbWVzO1xuICAgIH1cblxuICAgIEBPdmVycmlkZVxuICAgIHZpc2l0VGVybWluYWwobm9kZTogVGVybWluYWxOb2RlKSB7XG4gICAgICAgIGxldCByZXMgPSBub2RlLnRvU3RyaW5nVHJlZSgpO1xuICAgICAgICBpZihyZXMgPT09ICdhbmQnKVxuICAgICAgICAgICAgcmV0dXJuICcmJztcbiAgICAgICAgZWxzZSBpZihyZXMgPT09ICdvcicpXG4gICAgICAgICAgICByZXR1cm4gJ3wnO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgIH1cblxuICAgIEBPdmVycmlkZVxuICAgIHZpc2l0RXJyb3JOb2RlKG5vZGU6IEVycm9yTm9kZSkge1xuICAgICAgICBsZXQgcmVzID0gbm9kZS50b1N0cmluZ1RyZWUoKTtcbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICB2aXNpdCh0cmVlOiBQYXJzZVRyZWUpIHtcbiAgICAgICAgcmV0dXJuIHRyZWUuYWNjZXB0KHRoaXMpO1xuICAgIH1cbiAgICB2aXNpdFVuYmluZGluZ19zdGF0ZW1lbnQoY3R4OiBVbmJpbmRpbmdfc3RhdGVtZW50Q29udGV4dCkgOiBzdHJpbmcge1xuICAgICAgICBsZXQgc3RhdGVtZW50ID0gbmV3IFN0YXRlbWVudCgpO1xuICAgICAgICBzdGF0ZW1lbnQubm9taW5hdG9yID0gY3R4Lm5vbWluYXRvcigpLmFjY2VwdCh0aGlzKTtcbiAgICAgICAgc3RhdGVtZW50Lm5vbWluZWUgPSBjdHgubm9taW5lZSgpLmFjY2VwdCh0aGlzKTtcbiAgICAgICAgaWYoY3R4LmJpbmRpbmdfY29uc3RyKCkgIT09IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHN0YXRlbWVudC5iaW5kaW5nQ29uc3RyYWludCA9IHRoaXMuY3JlYXRlRGlzanVuY3Rpb25TZXQoY3R4LmJpbmRpbmdfY29uc3RyKCkuYWNjZXB0KHRoaXMpKTtcbiAgICAgICAgaWYoY3R4LmVuZG9yc2VtZW50X2NvbnN0cigpICE9PSB1bmRlZmluZWQpXG4gICAgICAgICAgICBzdGF0ZW1lbnQuZW5kb3JzZW1lbnRDb25zdHJhaW50ID0gdGhpcy5jcmVhdGVEaXNqdW5jdGlvblNldChjdHguZW5kb3JzZW1lbnRfY29uc3RyKCkuYWNjZXB0KHRoaXMpKTtcbiAgICAgICAgdGhpcy5wb2xpY3kuYWRkUmVsZWFzZVN0YXRlbWVudChzdGF0ZW1lbnQpO1xuICAgICAgICByZXR1cm4gJyc7XG5cbiAgICB9XG4gICAgdmlzaXRCaW5kaW5nX3N0YXRlbWVudChjdHg6IEJpbmRpbmdfc3RhdGVtZW50Q29udGV4dCkgOiBzdHJpbmcge1xuICAgICAgICBpZihjdHguaXNfY3JlYXRvcigpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGxldCBjcmVhdG9yID0gY3R4LmlzX2NyZWF0b3IoKS5hY2NlcHQodGhpcyk7XG4gICAgICAgICAgICB0aGlzLnBvbGljeS5zZXRDcmVhdG9yKGNyZWF0b3IpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IHN0YXRlbWVudCA9IG5ldyBTdGF0ZW1lbnQoKTtcbiAgICAgICAgICAgIHN0YXRlbWVudC5ub21pbmF0b3IgPSBjdHgubm9taW5hdG9yKCkuYWNjZXB0KHRoaXMpO1xuICAgICAgICAgICAgc3RhdGVtZW50Lm5vbWluZWUgPSBjdHgubm9taW5lZSgpLmFjY2VwdCh0aGlzKTtcbiAgICAgICAgICAgIGlmKGN0eC5iaW5kaW5nX2NvbnN0cigpICE9PSB1bmRlZmluZWQpXG4gICAgICAgICAgICAgICBzdGF0ZW1lbnQuYmluZGluZ0NvbnN0cmFpbnQgPSB0aGlzLmNyZWF0ZURpc2p1bmN0aW9uU2V0KGN0eC5iaW5kaW5nX2NvbnN0cigpLmFjY2VwdCh0aGlzKSk7XG4gICAgICAgICAgICBpZihjdHguZW5kb3JzZW1lbnRfY29uc3RyKCkgIT09IHVuZGVmaW5lZClcbiAgICAgICAgICAgICAgICBzdGF0ZW1lbnQuZW5kb3JzZW1lbnRDb25zdHJhaW50ID0gdGhpcy5jcmVhdGVEaXNqdW5jdGlvblNldChjdHguZW5kb3JzZW1lbnRfY29uc3RyKCkuYWNjZXB0KHRoaXMpKTtcbiAgICAgICAgICAgIHRoaXMucG9saWN5LmFkZE5vbWluYXRpb25TdGF0ZW1lbnQoc3RhdGVtZW50KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuICAgIHZpc2l0SXNfY3JlYXRvcihjdHg6IElzX2NyZWF0b3JDb250ZXh0KSA6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBjdHgucm9sZSgpLnRleHQ7ICAgICAgICBcbiAgICB9XG4gICAgdmlzaXROb21pbmF0b3IgKGN0eDogTm9taW5hdG9yQ29udGV4dCkgOiBzdHJpbmcge1xuICAgICAgICB0aGlzLnBvbGljeS5hZGRSb2xlKGN0eC50ZXh0KTtcbiAgICAgICAgcmV0dXJuIGN0eC50ZXh0O1xuICAgIH1cbiAgIFx0dmlzaXROb21pbmVlKGN0eDogTm9taW5lZUNvbnRleHQpIDogc3RyaW5nIHtcbiAgICAgICAgdGhpcy5wb2xpY3kuYWRkUm9sZShjdHgudGV4dCk7XG4gICAgICAgIHJldHVybiBjdHgudGV4dDtcbiAgICB9XG4gICAgdmlzaXRSb2xlKGN0eDogUm9sZUNvbnRleHQpIDogc3RyaW5nIHtcbiAgICAgICAgdGhpcy5wb2xpY3kuYWRkUm9sZShjdHgudGV4dCk7XG4gICAgICAgIHJldHVybiBjdHgudGV4dDtcbiAgICB9XG4gICAgdmlzaXRCaW5kaW5nX2NvbnN0cihjdHg6IEJpbmRpbmdfY29uc3RyQ29udGV4dCkgOiBzdHJpbmcge1xuICAgICAgICBsZXQgbmVnID0gY3R4Lk5PVCgpID09PSB1bmRlZmluZWQgPyAnKycgOiAnLSc7XG4gICAgICAgIHJldHVybiBuZWcgKyBjdHguc2V0X2V4cHJlc2lvbigpLmFjY2VwdCh0aGlzKTtcbiAgICB9XG4gICAgdmlzaXRFbmRvcnNlbWVudF9jb25zdHIoY3R4OiBFbmRvcnNlbWVudF9jb25zdHJDb250ZXh0KSA6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAnKycgKyBjdHguc2V0X2V4cHJlc2lvbigpLmFjY2VwdCh0aGlzKTtcbiAgICB9XG4gICAgdmlzaXRTZXRfZXhwcmVzaW9uKGN0eDogU2V0X2V4cHJlc2lvbkNvbnRleHQpIDogc3RyaW5nIHtcbiAgICAgICAgbGV0IGV4cCA9ICcnO1xuICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgY3R4LmNoaWxkQ291bnQ7IGkrKykgXG4gICAgICAgICAgICBleHAgKz0gY3R4LmdldENoaWxkKGkpLmFjY2VwdCh0aGlzKTtcbiAgICAgICAgcmV0dXJuIGV4cDtcbiAgICB9XG4gICAgdmlzaXRDaGlsZHJlbihub2RlOiBSdWxlTm9kZSkgOiBzdHJpbmcge1xuXG4gICAgICAgbGV0IG5vZGVOYW1lID0gdGhpcy5fbmFtZXNbbm9kZS5ydWxlQ29udGV4dC5ydWxlSW5kZXhdO1xuICAgICAgIGxldCByZXMgPSAnJztcbiAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY2hpbGRDb3VudDsgaSsrKSBcbiAgICAgICAgICAgIHJlcyArPSBub2RlLmdldENoaWxkKGkpLmFjY2VwdCh0aGlzKTtcbiAgICAgICAgcmV0dXJuIHJlcztcbiAgXG4gICAgfVxuICAgIGNyZWF0ZURpc2p1bmN0aW9uU2V0KHNldFN0cjogc3RyaW5nKSA6IERpc2p1bmN0aW9uU2V0IHtcbiAgICAgICAgbGV0IGRpc2p1bmN0aW9uU2V0ID0gbmV3IERpc2p1bmN0aW9uU2V0KCk7XG4gICAgICAgIGRpc2p1bmN0aW9uU2V0LmlzTmVnYXRpdmUgPSBzZXRTdHJbMF0gPT09ICcrJyA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgICAgbGV0IGNvbmpTID0gc2V0U3RyLnN1YnN0cigxKS5zcGxpdCgnfCcpO1xuICAgICAgICBjb25qUy5mb3JFYWNoKHZhbHVlID0+IHtcbiAgICAgICAgICAgIGxldCBjb25qdW50aW9uU2V0ID0gbmV3IENvbmp1bmN0aW9uU2V0KCk7XG4gICAgICAgICAgICBjb25qdW50aW9uU2V0LnJvbGVzID0gdmFsdWUuc3BsaXQoJyYnKTtcbiAgICAgICAgICAgIGRpc2p1bmN0aW9uU2V0LmNvbmp1bmN0aW9uU2V0cy5wdXNoKGNvbmp1bnRpb25TZXQpO1xuICAgICAgICB9KVxuICAgICAgICByZXR1cm4gZGlzanVuY3Rpb25TZXQ7XG4gICAgfVxuXG59Il19