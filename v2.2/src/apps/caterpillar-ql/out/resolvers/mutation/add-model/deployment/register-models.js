"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _debug2 = _interopRequireDefault(require("debug"));

var _repo = require("../../../repo");

var _continueRegistration = _interopRequireDefault(require("./continue-registration"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var debug = (0, _debug2["default"])('caterpillarql:add-model:register-models');

var registerModels = function registerModels(web3, registryContract, currentIndex, sortedElements, nodeIndexes, modelInfo, contracts) {
  var nodeName = sortedElements[currentIndex].nodeName;
  var gNodeId = sortedElements[currentIndex].nodeId;
  var controlFlowInfo = modelInfo.controlFlowInfoMap.get(gNodeId);
  if (modelInfo.globalNodeMap.get(gNodeId).$type === 'bpmn:StartEvent') controlFlowInfo = modelInfo.controlFlowInfoMap.get(modelInfo.globalNodeMap.get(gNodeId).$parent.id);

  if (controlFlowInfo) {
    var indexToFunctionName = [];
    var childrenSubproc = [];
    controlFlowInfo.nodeList.forEach(function (nodeId) {
      var element = modelInfo.globalNodeMap.get(nodeId);

      if (controlFlowInfo.nodeList.indexOf(nodeId) >= 0) {
        var type = "None";
        var role = "None";
        var indexRole = 0;
        if (controlFlowInfo.callActivities.has(nodeId) || controlFlowInfo.multiinstanceActivities.has(nodeId) || controlFlowInfo.nonInterruptingEvents.has(nodeId)) type = "Separate-Instance";else if (element.$type === 'bpmn:ServiceTask') type = "Service";else if (element.$type === 'bpmn:UserTask' || element.$type === 'bpmn:ReceiveTask' || controlFlowInfo.catchingMessages.indexOf(nodeId) >= 0) {
          type = "Workitem";
          if (!controlFlowInfo.taskRoleMap.has(nodeId)) throw 'No role related to User Task: ' + controlFlowInfo.nodeNameMap.get(nodeId);
          role = controlFlowInfo.taskRoleMap.get(nodeId);
        }
        indexToFunctionName[controlFlowInfo.nodeIndexMap.get(nodeId)] = {
          name: controlFlowInfo.nodeNameMap.get(nodeId),
          id: nodeId,
          type: type,
          role: role
        };

        if (controlFlowInfo.callActivities.has(nodeId) || controlFlowInfo.multiinstanceActivities.has(nodeId) || controlFlowInfo.nonInterruptingEvents.has(nodeId)) {
          childrenSubproc.push(nodeId);
          sortedElements[nodeIndexes.get(nodeId)].nodeIndex = controlFlowInfo.nodeIndexMap.get(nodeId);
          if (controlFlowInfo.externalBundles.has(nodeId)) sortedElements[nodeIndexes.get(nodeId)].bundleId = controlFlowInfo.externalBundles.get(nodeId);
        }
      }
    });
    var bpmnModel = currentIndex < sortedElements.length - 1 ? 'empty' : modelInfo.bpmn;
    var worklistAbi = contracts["".concat(modelInfo.id)]["".concat(nodeName, "_Worklist")] ? contracts["".concat(modelInfo.id)]["".concat(nodeName, "_Worklist")].abi : 'undefined';
    return _repo.process.create({
      rootProcessID: gNodeId,
      rootProcessName: nodeName,
      bpmnModel: bpmnModel,
      solidityCode: modelInfo.solidity,
      abi: JSON.stringify(contracts["".concat(modelInfo.id)]["".concat(nodeName, "_Contract")].abi),
      bytecode: contracts["".concat(modelInfo.id)]["".concat(nodeName, "_Contract")].evm.bytecode.object,
      indexToElement: indexToFunctionName,
      worklistAbi: JSON.stringify(worklistAbi)
    }).then(function (repoData) {
      var idAsString = repoData._id.toString();

      sortedElements[currentIndex].bundleId = idAsString;
      sortedElements[currentIndex].bundleParent = idAsString;
      childrenSubproc.forEach(function (childId) {
        sortedElements[nodeIndexes.get(childId)].bundleParent = idAsString;
      });
      debug("Compilation artifacts of ".concat(nodeName, " updated in repository with id ").concat(idAsString));
      return (0, _continueRegistration["default"])(web3, registryContract, currentIndex, sortedElements, nodeIndexes, modelInfo, contracts, registerModels);
    });
  } else {
    return (0, _continueRegistration["default"])(web3, registryContract, currentIndex, sortedElements, nodeIndexes, modelInfo, contracts, registerModels);
  }
};

var _default = registerModels;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2FwcC9yZXNvbHZlcnMvbXV0YXRpb24vYWRkLW1vZGVsL2RlcGxveW1lbnQvcmVnaXN0ZXItbW9kZWxzLnRzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVnaXN0ZXJNb2RlbHMiLCJ3ZWIzIiwicmVnaXN0cnlDb250cmFjdCIsImN1cnJlbnRJbmRleCIsInNvcnRlZEVsZW1lbnRzIiwibm9kZUluZGV4ZXMiLCJtb2RlbEluZm8iLCJjb250cmFjdHMiLCJub2RlTmFtZSIsImdOb2RlSWQiLCJub2RlSWQiLCJjb250cm9sRmxvd0luZm8iLCJjb250cm9sRmxvd0luZm9NYXAiLCJnZXQiLCJnbG9iYWxOb2RlTWFwIiwiJHR5cGUiLCIkcGFyZW50IiwiaWQiLCJpbmRleFRvRnVuY3Rpb25OYW1lIiwiY2hpbGRyZW5TdWJwcm9jIiwibm9kZUxpc3QiLCJmb3JFYWNoIiwiZWxlbWVudCIsImluZGV4T2YiLCJ0eXBlIiwicm9sZSIsImluZGV4Um9sZSIsImNhbGxBY3Rpdml0aWVzIiwiaGFzIiwibXVsdGlpbnN0YW5jZUFjdGl2aXRpZXMiLCJub25JbnRlcnJ1cHRpbmdFdmVudHMiLCJjYXRjaGluZ01lc3NhZ2VzIiwidGFza1JvbGVNYXAiLCJub2RlTmFtZU1hcCIsIm5vZGVJbmRleE1hcCIsIm5hbWUiLCJwdXNoIiwibm9kZUluZGV4IiwiZXh0ZXJuYWxCdW5kbGVzIiwiYnVuZGxlSWQiLCJicG1uTW9kZWwiLCJsZW5ndGgiLCJicG1uIiwid29ya2xpc3RBYmkiLCJhYmkiLCJwcm9jZXNzIiwiY3JlYXRlIiwicm9vdFByb2Nlc3NJRCIsInJvb3RQcm9jZXNzTmFtZSIsInNvbGlkaXR5Q29kZSIsInNvbGlkaXR5IiwiSlNPTiIsInN0cmluZ2lmeSIsImJ5dGVjb2RlIiwiZXZtIiwib2JqZWN0IiwiaW5kZXhUb0VsZW1lbnQiLCJ0aGVuIiwicmVwb0RhdGEiLCJpZEFzU3RyaW5nIiwiX2lkIiwidG9TdHJpbmciLCJidW5kbGVQYXJlbnQiLCJj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TDtBQUNBLGFBQU8sc0NBQXFCMUQsSUFBckIsRUFBMkJDLGdCQUEzQixFQUE2Q0MsWUFBN0MsRUFBMkRDLGNBQTNELEVBQTJFQyxXQUEzRSxFQUF3RkMsU0FBeEYsRUFBbUdDLFNBQW5HLEVBQThHUCxjQUE5RyxDQUFQO0FBQ0QsS0F0QkUsQ0FBUDtBQXdCRCxHQTVERCxNQTRETztBQUNMLFdBQU8sc0NBQXFCQyxJQUFyQixFQUEyQkMsZ0JBQTNCLEVBQTZDQyxZQUE3QyxFQUEyREMsY0FBM0QsRUFBMkVDLFdBQTNFLEVBQXdGQyxTQUF4RixFQUFtR0MsU0FBbkcsRUFBOEdQLGNBQTlHLENBQVA7QUFDRDtBQUNGLENBN0VEOztlQStFZUEsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfZGVidWcgZnJvbSAnZGVidWcnXG5cbmltcG9ydCB7IHByb2Nlc3MgfSBmcm9tICcuLi8uLi8uLi9yZXBvJ1xuaW1wb3J0IGNvbnRpbnVlUmVnaXN0cmF0aW9uIGZyb20gJy4vY29udGludWUtcmVnaXN0cmF0aW9uJ1xuXG5jb25zdCBkZWJ1ZyA9IF9kZWJ1ZygnY2F0ZXJwaWxsYXJxbDphZGQtbW9kZWw6cmVnaXN0ZXItbW9kZWxzJylcblxubGV0IHJlZ2lzdGVyTW9kZWxzID0gKFxuICB3ZWIzLFxuICByZWdpc3RyeUNvbnRyYWN0LFxuICBjdXJyZW50SW5kZXgsXG4gIHNvcnRlZEVsZW1lbnRzLFxuICBub2RlSW5kZXhlcyxcbiAgbW9kZWxJbmZvLFxuICBjb250cmFjdHMsXG4pID0+IHtcbiAgbGV0IG5vZGVOYW1lID0gc29ydGVkRWxlbWVudHNbY3VycmVudEluZGV4XS5ub2RlTmFtZTtcbiAgbGV0IGdOb2RlSWQgPSBzb3J0ZWRFbGVtZW50c1tjdXJyZW50SW5kZXhdLm5vZGVJZDtcbiAgbGV0IGNvbnRyb2xGbG93SW5mbyA9IG1vZGVsSW5mby5jb250cm9sRmxvd0luZm9NYXAuZ2V0KGdOb2RlSWQpO1xuICBpZiAobW9kZWxJbmZvLmdsb2JhbE5vZGVNYXAuZ2V0KGdOb2RlSWQpLiR0eXBlID09PSAnYnBtbjpTdGFydEV2ZW50JylcbiAgICBjb250cm9sRmxvd0luZm8gPSBtb2RlbEluZm8uY29udHJvbEZsb3dJbmZvTWFwLmdldChtb2RlbEluZm8uZ2xvYmFsTm9kZU1hcC5nZXQoZ05vZGVJZCkuJHBhcmVudC5pZCk7XG4gIGlmIChjb250cm9sRmxvd0luZm8pIHtcbiAgICBsZXQgaW5kZXhUb0Z1bmN0aW9uTmFtZSA9IFtdO1xuICAgIGxldCBjaGlsZHJlblN1YnByb2MgPSBbXTtcbiAgICBjb250cm9sRmxvd0luZm8ubm9kZUxpc3QuZm9yRWFjaChub2RlSWQgPT4ge1xuICAgICAgbGV0IGVsZW1lbnQgPSBtb2RlbEluZm8uZ2xvYmFsTm9kZU1hcC5nZXQobm9kZUlkKTtcbiAgICAgIGlmIChjb250cm9sRmxvd0luZm8ubm9kZUxpc3QuaW5kZXhPZihub2RlSWQpID49IDApIHtcbiAgICAgICAgbGV0IHR5cGUgPSBcIk5vbmVcIjtcbiAgICAgICAgbGV0IHJvbGUgPSBcIk5vbmVcIjtcbiAgICAgICAgbGV0IGluZGV4Um9sZSA9IDA7XG4gICAgICAgIGlmIChjb250cm9sRmxvd0luZm8uY2FsbEFjdGl2aXRpZXMuaGFzKG5vZGVJZCkgfHwgY29udHJvbEZsb3dJbmZvLm11bHRpaW5zdGFuY2VBY3Rpdml0aWVzLmhhcyhub2RlSWQpIHx8IGNvbnRyb2xGbG93SW5mby5ub25JbnRlcnJ1cHRpbmdFdmVudHMuaGFzKG5vZGVJZCkpXG4gICAgICAgICAgdHlwZSA9IFwiU2VwYXJhdGUtSW5zdGFuY2VcIjtcbiAgICAgICAgZWxzZSBpZiAoZWxlbWVudC4kdHlwZSA9PT0gJ2JwbW46U2VydmljZVRhc2snKVxuICAgICAgICAgIHR5cGUgPSBcIlNlcnZpY2VcIjtcbiAgICAgICAgZWxzZSBpZiAoZWxlbWVudC4kdHlwZSA9PT0gJ2JwbW46VXNlclRhc2snIHx8IGVsZW1lbnQuJHR5cGUgPT09ICdicG1uOlJlY2VpdmVUYXNrJyB8fCBjb250cm9sRmxvd0luZm8uY2F0Y2hpbmdNZXNzYWdlcy5pbmRleE9mKG5vZGVJZCkgPj0gMCkge1xuICAgICAgICAgIHR5cGUgPSBcIldvcmtpdGVtXCI7XG4gICAgICAgICAgaWYgKCFjb250cm9sRmxvd0luZm8udGFza1JvbGVNYXAuaGFzKG5vZGVJZCkpXG4gICAgICAgICAgICB0aHJvdyAnTm8gcm9sZSByZWxhdGVkIHRvIFVzZXIgVGFzazogJyArIGNvbnRyb2xGbG93SW5mby5ub2RlTmFtZU1hcC5nZXQobm9kZUlkKTtcbiAgICAgICAgICByb2xlID0gY29udHJvbEZsb3dJbmZvLnRhc2tSb2xlTWFwLmdldChub2RlSWQpO1xuICAgICAgICB9XG4gICAgICAgIGluZGV4VG9GdW5jdGlvbk5hbWVbY29udHJvbEZsb3dJbmZvLm5vZGVJbmRleE1hcC5nZXQobm9kZUlkKV0gPSB7XG4gICAgICAgICAgbmFtZTogY29udHJvbEZsb3dJbmZvLm5vZGVOYW1lTWFwLmdldChub2RlSWQpLFxuICAgICAgICAgIGlkOiBub2RlSWQsXG4gICAgICAgICAgdHlwZTogdHlwZSxcbiAgICAgICAgICByb2xlOiByb2xlXG4gICAgICAgIH07XG4gICAgICAgIGlmIChjb250cm9sRmxvd0luZm8uY2FsbEFjdGl2aXRpZXMuaGFzKG5vZGVJZCkgfHwgY29udHJvbEZsb3dJbmZvLm11bHRpaW5zdGFuY2VBY3Rpdml0aWVzLmhhcyhub2RlSWQpIHx8IGNvbnRyb2xGbG93SW5mby5ub25JbnRlcnJ1cHRpbmdFdmVudHMuaGFzKG5vZGVJZCkpIHtcbiAgICAgICAgICBjaGlsZHJlblN1YnByb2MucHVzaChub2RlSWQpO1xuICAgICAgICAgIHNvcnRlZEVsZW1lbnRzW25vZGVJbmRleGVzLmdldChub2RlSWQpXS5ub2RlSW5kZXggPSBjb250cm9sRmxvd0luZm8ubm9kZUluZGV4TWFwLmdldChub2RlSWQpO1xuICAgICAgICAgIGlmIChjb250cm9sRmxvd0luZm8uZXh0ZXJuYWxCdW5kbGVzLmhhcyhub2RlSWQpKVxuICAgICAgICAgICAgc29ydGVkRWxlbWVudHNbbm9kZUluZGV4ZXMuZ2V0KG5vZGVJZCldLmJ1bmRsZUlkID0gY29udHJvbEZsb3dJbmZvLmV4dGVybmFsQnVuZGxlcy5nZXQobm9kZUlkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGxldCBicG1uTW9kZWwgPSBjdXJyZW50SW5kZXggPCBzb3J0ZWRFbGVtZW50cy5sZW5ndGggLSAxID8gJ2VtcHR5JyA6IG1vZGVsSW5mby5icG1uO1xuICAgIFxuICAgIGxldCB3b3JrbGlzdEFiaSA9IGNvbnRyYWN0c1tgJHttb2RlbEluZm8uaWR9YF1bYCR7bm9kZU5hbWV9X1dvcmtsaXN0YF0gPyBjb250cmFjdHNbYCR7bW9kZWxJbmZvLmlkfWBdW2Ake25vZGVOYW1lfV9Xb3JrbGlzdGBdLmFiaSA6ICd1bmRlZmluZWQnO1xuICAgIHJldHVybiBwcm9jZXNzLmNyZWF0ZShcbiAgICAgIHtcbiAgICAgICAgcm9vdFByb2Nlc3NJRDogZ05vZGVJZCxcbiAgICAgICAgcm9vdFByb2Nlc3NOYW1lOiBub2RlTmFtZSxcbiAgICAgICAgYnBtbk1vZGVsOiBicG1uTW9kZWwsXG4gICAgICAgIHNvbGlkaXR5Q29kZTogbW9kZWxJbmZvLnNvbGlkaXR5LFxuICAgICAgICBhYmk6SlNPTi5zdHJpbmdpZnkoY29udHJhY3RzW2Ake21vZGVsSW5mby5pZH1gXVtgJHtub2RlTmFtZX1fQ29udHJhY3RgXS5hYmkpLFxuICAgICAgICBieXRlY29kZTogY29udHJhY3RzW2Ake21vZGVsSW5mby5pZH1gXVtgJHtub2RlTmFtZX1fQ29udHJhY3RgXS5ldm0uYnl0ZWNvZGUub2JqZWN0LFxuICAgICAgICBpbmRleFRvRWxlbWVudDogaW5kZXhUb0Z1bmN0aW9uTmFtZSxcbiAgICAgICAgd29ya2xpc3RBYmk6IEpTT04uc3RyaW5naWZ5KHdvcmtsaXN0QWJpKVxuICAgICAgfSxcbiAgICApXG4gICAgICAudGhlbihcbiAgICAgICAgKHJlcG9EYXRhKSA9PiB7XG4gICAgICAgICAgbGV0IGlkQXNTdHJpbmcgPSByZXBvRGF0YS5faWQudG9TdHJpbmcoKTtcbiAgICAgICAgICBzb3J0ZWRFbGVtZW50c1tjdXJyZW50SW5kZXhdLmJ1bmRsZUlkID0gaWRBc1N0cmluZztcbiAgICAgICAgICBzb3J0ZWRFbGVtZW50c1tjdXJyZW50SW5kZXhdLmJ1bmRsZVBhcmVudCA9IGlkQXNTdHJpbmc7XG4gICAgICAgICAgY2hpbGRyZW5TdWJwcm9jLmZvckVhY2goY2hpbGRJZCA9PiB7XG4gICAgICAgICAgICBzb3J0ZWRFbGVtZW50c1tub2RlSW5kZXhlcy5nZXQoY2hpbGRJZCldLmJ1bmRsZVBhcmVudCA9IGlkQXNTdHJpbmc7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgZGVidWcoYENvbXBpbGF0aW9uIGFydGlmYWN0cyBvZiAke25vZGVOYW1lfSB1cGRhdGVkIGluIHJlcG9zaXRvcnkgd2l0aCBpZCAke2lkQXNTdHJpbmd9YCk7XG4gICAgICAgICAgcmV0dXJuIGNvbnRpbnVlUmVnaXN0cmF0aW9uKHdlYjMsIHJlZ2lzdHJ5Q29udHJhY3QsIGN1cnJlbnRJbmRleCwgc29ydGVkRWxlbWVudHMsIG5vZGVJbmRleGVzLCBtb2RlbEluZm8sIGNvbnRyYWN0cywgcmVnaXN0ZXJNb2RlbHMpO1xuICAgICAgICB9XG4gICAgICApXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGNvbnRpbnVlUmVnaXN0cmF0aW9uKHdlYjMsIHJlZ2lzdHJ5Q29udHJhY3QsIGN1cnJlbnRJbmRleCwgc29ydGVkRWxlbWVudHMsIG5vZGVJbmRleGVzLCBtb2RlbEluZm8sIGNvbnRyYWN0cywgcmVnaXN0ZXJNb2RlbHMpO1xuICB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCByZWdpc3Rlck1vZGVsc1xuIl19