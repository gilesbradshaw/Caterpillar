"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _debug2 = _interopRequireDefault(require("debug"));

var _repo = require("../../../repo");

var _continueRegistration = _interopRequireDefault(require("./continue-registration"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debug = (0, _debug2.default)('caterpillarql:model:register-models');

let registerModels = (web3, registryContract, currentIndex, sortedElements, nodeIndexes, modelInfo, contracts) => {
  let nodeName = sortedElements[currentIndex].nodeName;
  let gNodeId = sortedElements[currentIndex].nodeId;
  let controlFlowInfo = modelInfo.controlFlowInfoMap.get(gNodeId);
  if (modelInfo.globalNodeMap.get(gNodeId).$type === 'bpmn:StartEvent') controlFlowInfo = modelInfo.controlFlowInfoMap.get(modelInfo.globalNodeMap.get(gNodeId).$parent.id);

  if (controlFlowInfo) {
    let indexToFunctionName = [];
    let childrenSubproc = [];
    controlFlowInfo.nodeList.forEach(nodeId => {
      let element = modelInfo.globalNodeMap.get(nodeId);

      if (controlFlowInfo.nodeList.indexOf(nodeId) >= 0) {
        let type = "None";
        let role = "None";
        let indexRole = 0;
        if (controlFlowInfo.callActivities.has(nodeId) || controlFlowInfo.multiinstanceActivities.has(nodeId) || controlFlowInfo.nonInterruptingEvents.has(nodeId)) type = "Separate-Instance";else if (element.$type === 'bpmn:ServiceTask') type = "Service";else if (element.$type === 'bpmn:UserTask' || element.$type === 'bpmn:ReceiveTask' || controlFlowInfo.catchingMessages.indexOf(nodeId) >= 0) {
          type = "Workitem";
          if (!controlFlowInfo.taskRoleMap.has(nodeId)) throw 'No role related to User Task: ' + controlFlowInfo.nodeNameMap.get(nodeId);
          role = controlFlowInfo.taskRoleMap.get(nodeId);
        }
        indexToFunctionName[controlFlowInfo.nodeIndexMap.get(nodeId)] = {
          name: controlFlowInfo.nodeNameMap.get(nodeId),
          id: nodeId,
          type: type,
          role: role
        };

        if (controlFlowInfo.callActivities.has(nodeId) || controlFlowInfo.multiinstanceActivities.has(nodeId) || controlFlowInfo.nonInterruptingEvents.has(nodeId)) {
          childrenSubproc.push(nodeId);
          sortedElements[nodeIndexes.get(nodeId)].nodeIndex = controlFlowInfo.nodeIndexMap.get(nodeId);
          if (controlFlowInfo.externalBundles.has(nodeId)) sortedElements[nodeIndexes.get(nodeId)].bundleId = controlFlowInfo.externalBundles.get(nodeId);
        }
      }
    });
    let bpmnModel = currentIndex < sortedElements.length - 1 ? 'empty' : modelInfo.bpmn;
    let worklistAbi = contracts[`${modelInfo.id}`][`${nodeName}_Worklist`] ? contracts[`${modelInfo.id}`][`${nodeName}_Worklist`].abi : 'undefined';
    return _repo.process.create({
      rootProcessID: gNodeId,
      rootProcessName: nodeName,
      bpmnModel: bpmnModel,
      solidityCode: modelInfo.solidity,
      abi: JSON.stringify(contracts[`${modelInfo.id}`][`${nodeName}_Contract`].abi),
      bytecode: contracts[`${modelInfo.id}`][`${nodeName}_Contract`].evm.bytecode.object,
      indexToElement: indexToFunctionName,
      worklistAbi: JSON.stringify(worklistAbi)
    }).then(repoData => {
      let idAsString = repoData._id.toString();

      sortedElements[currentIndex].bundleId = idAsString;
      sortedElements[currentIndex].bundleParent = idAsString;
      childrenSubproc.forEach(childId => {
        sortedElements[nodeIndexes.get(childId)].bundleParent = idAsString;
      });
      debug(`Compilation artifacts of ${nodeName} updated in repository with id ${idAsString}`);
      return (0, _continueRegistration.default)(web3, registryContract, currentIndex, sortedElements, nodeIndexes, modelInfo, contracts, registerModels);
    });
  } else {
    return (0, _continueRegistration.default)(web3, registryContract, currentIndex, sortedElements, nodeIndexes, modelInfo, contracts, registerModels);
  }
};

var _default = registerModels;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2FwcC9yZXNvbHZlcnMvbXV0YXRpb24vbW9kZWwvZGVwbG95bWVudC9yZWdpc3Rlci1tb2RlbHMudHMiXSwibmFtZXMiOlsiZGVidWciLCJyZWdpc3Rlck1vZGVscyIsIndlYjMiLCJyZWdpc3RyeUNvbnRyYWN0IiwiY3VycmVudEluZGV4Iiwic29ydGVkRWxlbWVudHMiLCJub2RlSW5kZXhlcyIsIm1vZGVsSW5mbyIsImNvbnRyYWN0cyIsIm5vZGVOYW1lIiwiZ05vZGVJZCIsIm5vZGVJZCIsImNvbnRyb2xGbG93SW5mbyIsImNvbnRyb2xGbG93SW5mb01hcCIsImdldCIsImdsb2JhbE5vZGVNYXAiLCIkdHlwZSIsIiRwYXJlbnQiLCJpZCIsImluZGV4VG9GdW5jdGlvbk5hbWUiLCJjaGlsZHJlblN1YnByb2MiLCJub2RlTGlzdCIsImZvckVhY2giLCJlbGVtZW50IiwiaW5kZXhPZiIsInR5cGUiLCJyb2xlIiwiaW5kZXhSb2xlIiwiY2FsbEFjdGl2aXRpZXMiLCJoYXMiLCJtdWx0aWluc3RhbmNlQWN0aXZpdGllcyIsIm5vbkludGVycnVwdGluZ0V2ZW50cyIsImNhdGNoaW5nTWVzc2FnZXMiLCJ0YXNrUm9sZU1hcCIsIm5vZGVOYW1lTWFwIiwibm9kZUluZGV4TWFwIiwibmFtZSIsInB1c2giLCJub2RlSW5kZXgiLCJleHRlcm5hbEJ1bmRsZXMiLCJidW5kbGVJZCIsImJwbW5Nb2RlbCIsImxlbmd0aCIsImJwbW4iLCJ3b3JrbGlzdEFiaSIsImFiaSIsInByb2Nlc3MiLCJjcmVhdGUiLCJyb290UHJvY2Vzc0lEIiwicm9vdFByb2Nlc3NOYW1lIiwic29saWRpdHlDb2RlIiwic29saWRpdHkiLCJKU09OIiwic3RyaW5naWZ5IiwiYnl0ZWNvZGUiLCJldm0iLCJvYmplY3QiLCJpbmRleFRvRWxlbWVudCIsInRoZW4iLCJyZXBvRGF0YSIsImlkQXNTdHJpbmciLCJfaWQiLCJ0b1N0cmluZyIsImJ1bmRsZVBhcmVudCIsImNoaWxk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R0E1RCxNQUFBQSxLQUFLLENBQUUsNEJBQTJCUyxRQUFTLGtDQUFpQ21ELFVBQVcsRUFBbEYsQ0FBTDtBQUNBLGFBQU8sbUNBQXFCMUQsSUFBckIsRUFBMkJDLGdCQUEzQixFQUE2Q0MsWUFBN0MsRUFBMkRDLGNBQTNELEVBQTJFQyxXQUEzRSxFQUF3RkMsU0FBeEYsRUFBbUdDLFNBQW5HLEVBQThHUCxjQUE5RyxDQUFQO0FBQ0QsS0F0QkUsQ0FBUDtBQXdCRCxHQTVERCxNQTRETztBQUNMLFdBQU8sbUNBQXFCQyxJQUFyQixFQUEyQkMsZ0JBQTNCLEVBQTZDQyxZQUE3QyxFQUEyREMsY0FBM0QsRUFBMkVDLFdBQTNFLEVBQXdGQyxTQUF4RixFQUFtR0MsU0FBbkcsRUFBOEdQLGNBQTlHLENBQVA7QUFDRDtBQUNGLENBN0VEOztlQStFZUEsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfZGVidWcgZnJvbSAnZGVidWcnXG5cbmltcG9ydCB7IHByb2Nlc3MgfSBmcm9tICcuLi8uLi8uLi9yZXBvJ1xuaW1wb3J0IGNvbnRpbnVlUmVnaXN0cmF0aW9uIGZyb20gJy4vY29udGludWUtcmVnaXN0cmF0aW9uJ1xuXG5jb25zdCBkZWJ1ZyA9IF9kZWJ1ZygnY2F0ZXJwaWxsYXJxbDptb2RlbDpyZWdpc3Rlci1tb2RlbHMnKVxuXG5sZXQgcmVnaXN0ZXJNb2RlbHMgPSAoXG4gIHdlYjMsXG4gIHJlZ2lzdHJ5Q29udHJhY3QsXG4gIGN1cnJlbnRJbmRleCxcbiAgc29ydGVkRWxlbWVudHMsXG4gIG5vZGVJbmRleGVzLFxuICBtb2RlbEluZm8sXG4gIGNvbnRyYWN0cyxcbikgPT4ge1xuICBsZXQgbm9kZU5hbWUgPSBzb3J0ZWRFbGVtZW50c1tjdXJyZW50SW5kZXhdLm5vZGVOYW1lO1xuICBsZXQgZ05vZGVJZCA9IHNvcnRlZEVsZW1lbnRzW2N1cnJlbnRJbmRleF0ubm9kZUlkO1xuICBsZXQgY29udHJvbEZsb3dJbmZvID0gbW9kZWxJbmZvLmNvbnRyb2xGbG93SW5mb01hcC5nZXQoZ05vZGVJZCk7XG4gIGlmIChtb2RlbEluZm8uZ2xvYmFsTm9kZU1hcC5nZXQoZ05vZGVJZCkuJHR5cGUgPT09ICdicG1uOlN0YXJ0RXZlbnQnKVxuICAgIGNvbnRyb2xGbG93SW5mbyA9IG1vZGVsSW5mby5jb250cm9sRmxvd0luZm9NYXAuZ2V0KG1vZGVsSW5mby5nbG9iYWxOb2RlTWFwLmdldChnTm9kZUlkKS4kcGFyZW50LmlkKTtcbiAgaWYgKGNvbnRyb2xGbG93SW5mbykge1xuICAgIGxldCBpbmRleFRvRnVuY3Rpb25OYW1lID0gW107XG4gICAgbGV0IGNoaWxkcmVuU3VicHJvYyA9IFtdO1xuICAgIGNvbnRyb2xGbG93SW5mby5ub2RlTGlzdC5mb3JFYWNoKG5vZGVJZCA9PiB7XG4gICAgICBsZXQgZWxlbWVudCA9IG1vZGVsSW5mby5nbG9iYWxOb2RlTWFwLmdldChub2RlSWQpO1xuICAgICAgaWYgKGNvbnRyb2xGbG93SW5mby5ub2RlTGlzdC5pbmRleE9mKG5vZGVJZCkgPj0gMCkge1xuICAgICAgICBsZXQgdHlwZSA9IFwiTm9uZVwiO1xuICAgICAgICBsZXQgcm9sZSA9IFwiTm9uZVwiO1xuICAgICAgICBsZXQgaW5kZXhSb2xlID0gMDtcbiAgICAgICAgaWYgKGNvbnRyb2xGbG93SW5mby5jYWxsQWN0aXZpdGllcy5oYXMobm9kZUlkKSB8fCBjb250cm9sRmxvd0luZm8ubXVsdGlpbnN0YW5jZUFjdGl2aXRpZXMuaGFzKG5vZGVJZCkgfHwgY29udHJvbEZsb3dJbmZvLm5vbkludGVycnVwdGluZ0V2ZW50cy5oYXMobm9kZUlkKSlcbiAgICAgICAgICB0eXBlID0gXCJTZXBhcmF0ZS1JbnN0YW5jZVwiO1xuICAgICAgICBlbHNlIGlmIChlbGVtZW50LiR0eXBlID09PSAnYnBtbjpTZXJ2aWNlVGFzaycpXG4gICAgICAgICAgdHlwZSA9IFwiU2VydmljZVwiO1xuICAgICAgICBlbHNlIGlmIChlbGVtZW50LiR0eXBlID09PSAnYnBtbjpVc2VyVGFzaycgfHwgZWxlbWVudC4kdHlwZSA9PT0gJ2JwbW46UmVjZWl2ZVRhc2snIHx8IGNvbnRyb2xGbG93SW5mby5jYXRjaGluZ01lc3NhZ2VzLmluZGV4T2Yobm9kZUlkKSA+PSAwKSB7XG4gICAgICAgICAgdHlwZSA9IFwiV29ya2l0ZW1cIjtcbiAgICAgICAgICBpZiAoIWNvbnRyb2xGbG93SW5mby50YXNrUm9sZU1hcC5oYXMobm9kZUlkKSlcbiAgICAgICAgICAgIHRocm93ICdObyByb2xlIHJlbGF0ZWQgdG8gVXNlciBUYXNrOiAnICsgY29udHJvbEZsb3dJbmZvLm5vZGVOYW1lTWFwLmdldChub2RlSWQpO1xuICAgICAgICAgIHJvbGUgPSBjb250cm9sRmxvd0luZm8udGFza1JvbGVNYXAuZ2V0KG5vZGVJZCk7XG4gICAgICAgIH1cbiAgICAgICAgaW5kZXhUb0Z1bmN0aW9uTmFtZVtjb250cm9sRmxvd0luZm8ubm9kZUluZGV4TWFwLmdldChub2RlSWQpXSA9IHtcbiAgICAgICAgICBuYW1lOiBjb250cm9sRmxvd0luZm8ubm9kZU5hbWVNYXAuZ2V0KG5vZGVJZCksXG4gICAgICAgICAgaWQ6IG5vZGVJZCxcbiAgICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICAgIHJvbGU6IHJvbGVcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKGNvbnRyb2xGbG93SW5mby5jYWxsQWN0aXZpdGllcy5oYXMobm9kZUlkKSB8fCBjb250cm9sRmxvd0luZm8ubXVsdGlpbnN0YW5jZUFjdGl2aXRpZXMuaGFzKG5vZGVJZCkgfHwgY29udHJvbEZsb3dJbmZvLm5vbkludGVycnVwdGluZ0V2ZW50cy5oYXMobm9kZUlkKSkge1xuICAgICAgICAgIGNoaWxkcmVuU3VicHJvYy5wdXNoKG5vZGVJZCk7XG4gICAgICAgICAgc29ydGVkRWxlbWVudHNbbm9kZUluZGV4ZXMuZ2V0KG5vZGVJZCldLm5vZGVJbmRleCA9IGNvbnRyb2xGbG93SW5mby5ub2RlSW5kZXhNYXAuZ2V0KG5vZGVJZCk7XG4gICAgICAgICAgaWYgKGNvbnRyb2xGbG93SW5mby5leHRlcm5hbEJ1bmRsZXMuaGFzKG5vZGVJZCkpXG4gICAgICAgICAgICBzb3J0ZWRFbGVtZW50c1tub2RlSW5kZXhlcy5nZXQobm9kZUlkKV0uYnVuZGxlSWQgPSBjb250cm9sRmxvd0luZm8uZXh0ZXJuYWxCdW5kbGVzLmdldChub2RlSWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgbGV0IGJwbW5Nb2RlbCA9IGN1cnJlbnRJbmRleCA8IHNvcnRlZEVsZW1lbnRzLmxlbmd0aCAtIDEgPyAnZW1wdHknIDogbW9kZWxJbmZvLmJwbW47XG4gICAgXG4gICAgbGV0IHdvcmtsaXN0QWJpID0gY29udHJhY3RzW2Ake21vZGVsSW5mby5pZH1gXVtgJHtub2RlTmFtZX1fV29ya2xpc3RgXSA/IGNvbnRyYWN0c1tgJHttb2RlbEluZm8uaWR9YF1bYCR7bm9kZU5hbWV9X1dvcmtsaXN0YF0uYWJpIDogJ3VuZGVmaW5lZCc7XG4gICAgcmV0dXJuIHByb2Nlc3MuY3JlYXRlKFxuICAgICAge1xuICAgICAgICByb290UHJvY2Vzc0lEOiBnTm9kZUlkLFxuICAgICAgICByb290UHJvY2Vzc05hbWU6IG5vZGVOYW1lLFxuICAgICAgICBicG1uTW9kZWw6IGJwbW5Nb2RlbCxcbiAgICAgICAgc29saWRpdHlDb2RlOiBtb2RlbEluZm8uc29saWRpdHksXG4gICAgICAgIGFiaTpKU09OLnN0cmluZ2lmeShjb250cmFjdHNbYCR7bW9kZWxJbmZvLmlkfWBdW2Ake25vZGVOYW1lfV9Db250cmFjdGBdLmFiaSksXG4gICAgICAgIGJ5dGVjb2RlOiBjb250cmFjdHNbYCR7bW9kZWxJbmZvLmlkfWBdW2Ake25vZGVOYW1lfV9Db250cmFjdGBdLmV2bS5ieXRlY29kZS5vYmplY3QsXG4gICAgICAgIGluZGV4VG9FbGVtZW50OiBpbmRleFRvRnVuY3Rpb25OYW1lLFxuICAgICAgICB3b3JrbGlzdEFiaTogSlNPTi5zdHJpbmdpZnkod29ya2xpc3RBYmkpXG4gICAgICB9LFxuICAgIClcbiAgICAgIC50aGVuKFxuICAgICAgICAocmVwb0RhdGEpID0+IHtcbiAgICAgICAgICBsZXQgaWRBc1N0cmluZyA9IHJlcG9EYXRhLl9pZC50b1N0cmluZygpO1xuICAgICAgICAgIHNvcnRlZEVsZW1lbnRzW2N1cnJlbnRJbmRleF0uYnVuZGxlSWQgPSBpZEFzU3RyaW5nO1xuICAgICAgICAgIHNvcnRlZEVsZW1lbnRzW2N1cnJlbnRJbmRleF0uYnVuZGxlUGFyZW50ID0gaWRBc1N0cmluZztcbiAgICAgICAgICBjaGlsZHJlblN1YnByb2MuZm9yRWFjaChjaGlsZElkID0+IHtcbiAgICAgICAgICAgIHNvcnRlZEVsZW1lbnRzW25vZGVJbmRleGVzLmdldChjaGlsZElkKV0uYnVuZGxlUGFyZW50ID0gaWRBc1N0cmluZztcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBkZWJ1ZyhgQ29tcGlsYXRpb24gYXJ0aWZhY3RzIG9mICR7bm9kZU5hbWV9IHVwZGF0ZWQgaW4gcmVwb3NpdG9yeSB3aXRoIGlkICR7aWRBc1N0cmluZ31gKTtcbiAgICAgICAgICByZXR1cm4gY29udGludWVSZWdpc3RyYXRpb24od2ViMywgcmVnaXN0cnlDb250cmFjdCwgY3VycmVudEluZGV4LCBzb3J0ZWRFbGVtZW50cywgbm9kZUluZGV4ZXMsIG1vZGVsSW5mbywgY29udHJhY3RzLCByZWdpc3Rlck1vZGVscyk7XG4gICAgICAgIH1cbiAgICAgIClcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gY29udGludWVSZWdpc3RyYXRpb24od2ViMywgcmVnaXN0cnlDb250cmFjdCwgY3VycmVudEluZGV4LCBzb3J0ZWRFbGVtZW50cywgbm9kZUluZGV4ZXMsIG1vZGVsSW5mbywgY29udHJhY3RzLCByZWdpc3Rlck1vZGVscyk7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IHJlZ2lzdGVyTW9kZWxzXG4iXX0=