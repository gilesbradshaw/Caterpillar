"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _debug2 = _interopRequireDefault(require("debug"));

var _repo = require("../repo");

var _registryContract = _interopRequireDefault(require("../util/registry-contract"));

var _findRoleMap = _interopRequireDefault(require("../util/find-role-map"));

var _createContract = _interopRequireDefault(require("../util/create-contract"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debug = (0, _debug2.default)('caterpillarql:mutation:process');

var _default = async ({
  creator,
  creatorRole,
  modelId,
  registry,
  web3
}) => {
  if (!web3.utils.isAddress(creator)) {
    throw new Error('Case creator is not a valid address');
  }

  const accounts = await web3.eth.personal.getAccounts();
  const contract = await (0, _registryContract.default)({
    address: registry,
    web3
  });
  const roleTaskId = await contract.taskRoleMapFromId({
    procId: web3.utils.fromAscii(modelId)
  });
  const [roleTask] = await _repo.roleTask.find({
    _id: roleTaskId
  });
  const policyId = await contract.bindingPolicyFromId({
    procId: web3.utils.fromAscii(modelId)
  });
  const [policy] = await _repo.policy.find({
    _id: policyId
  });
  const roleIndexMap = (0, _findRoleMap.default)(policy.indexToRole);

  if (!roleIndexMap.has(creatorRole)) {
    throw new Error('Case Creator Role NOT found');
  }

  const [model] = await _repo.process.find({
    _id: modelId
  });
  const accessControlContract = (0, _createContract.default)(web3)(JSON.parse(policy.accessControlAbi));
  const created = await accessControlContract.deploy({
    arguments: [registry, policy.address, roleTask.address],
    data: "0x" + policy.accessControlBytecode
  }).send({
    from: creator,
    gas: 4700000
  });
  console.log('access control contract created', created.address);
  const instance = await contract.newBundleInstanceFor({
    bundleId: web3.utils.fromAscii(model._id.toString()),
    parent: '0x0000000000000000000000000000000000000000',
    policyOpAddr: created.address
  })({
    from: creator,
    //accounts[0],
    gas: 4500000
  });
  debug({
    instance
  });
  const result = await new Promise((resolve, reject) => {
    const event = contract.events.NewInstanceCreatedFor({
      fromBlock: instance.blockNumber
    }).on('data', e => {
      if (e.transactionHash === instance.transactionHash) {
        event.removeListener('data');
        event.removeListener('error');
        resolve(e);
      }
    }).on('error', e => {
      event.removeListener('data');
      event.removeListener('error');
      reject(e);
    });
  });
  console.log('got to nominated..', creatorRole, roleIndexMap.get(creatorRole), creator, result.returnValues.processAddress.toString());
  const nominated = await created.methods.nominateCaseCreator(roleIndexMap.get(creatorRole), creator, result.returnValues.processAddress.toString()).send({
    from: creator,
    gas: 4700000
  });
  return {
    id: modelId,
    address: result.returnValues.processAddress,
    name: model.rootProcessName,
    bpmnModel: model.bpmnModel,
    registryContract: contract
  };
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2FwcC9yZXNvbHZlcnMvbXV0YXRpb24vcHJvY2Vzcy50cyJdLCJuYW1lcyI6WyJkZWJ1ZyIsImNyZWF0b3IiLCJjcmVhdG9yUm9sZSIsIm1vZGVsSWQiLCJyZWdpc3RyeSIsIndlYjMiLCJ1dGlscyIsImlzQWRkcmVzcyIsIkVycm9yIiwiYWNjb3VudHMiLCJldGgiLCJwZXJzb25hbCIsImdldEFjY291bnRzIiwiY29udHJhY3QiLCJhZGRyZXNzIiwicm9sZVRhc2tJZCIsInRhc2tSb2xlTWFwRnJvbUlkIiwicHJvY0lkIiwiZnJvbUFzY2lpIiwicm9sZVRhc2siLCJyb2xlVGFza1NjaGVtYSIsImZpbmQiLCJfaWQiLCJwb2xpY3lJZCIsImJpbmRpbmdQb2xpY3lGcm9tSWQiLCJwb2xpY3kiLCJwb2xpY3lTY2hlbWEiLCJyb2xlSW5kZXhNYXAiLCJpbmRleFRvUm9sZSIsImhhcyIsIm1vZGVsIiwicHJvY2Vzc1NjaGVtYSIsImFjY2Vzc0NvbnRyb2xDb250cmFjdCIsIkpTT04iLCJwYXJzZSIsImFjY2Vzc0NvbnRyb2xBYmkiLCJjcmVhdGVkIiwiZGVwbG95IiwiYXJndW1lbnRzIiwiZGF0YSIsImFjY2Vzc0NvbnRyb2xCeXRlY29kZSIsInNlbmQiLCJmcm9tIiwiZ2FzIiwiY29uc29sZSIsImxvZyIsImluc3RhbmNlIiwibmV3QnVuZGxlSW5zdGFuY2VGb3IiLCJidW5kbGVJZCIsInRvU3RyaW5nIiwicGFyZW50IiwicG9saWN5T3BBZGRyIiwicmVzdWx0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJldmVudCIsImV2ZW50cyIsIk5ld0luc3RhbmNlQ3JlYXRlZEZvciIsImZyb21CbG9jayIsImJsb2NrTnVtYmVyIiwib24iLCJlIiwidHJhbnNhY3Rpb25IYXNoIiwicmVtb3ZlTGlzdGVuZXIiLCJnZXQiLCJyZXR1cm5WYWx1ZXMiLCJwcm9jZXNzQWRkcmVzcyIsIm5vbWluYXRlZCIsIm1ldGhvZHMiLCJub21pbmF0ZUNhc2VDcmVhdG9yIiwiaWQiLCJuYW1lIiwicm9vdFByb2Nlc3NOYW1lIiwiYnBtbk1vZGVsIiwicmVnaXN0cnlDb250cmFjdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBOztBQUtBOztBQUVBOztBQUNBOzs7O0FBRUEsTUFBTUEsS0FBSyxHQUFHLHFCQUFPLGdDQUFQLENBQWQ7O2VBRWUsT0FBTztBQUNwQkMsRUFBQUEsT0FEb0I7QUFFcEJDLEVBQUFBLFdBRm9CO0FBR3BCQyxFQUFBQSxPQUhvQjtBQUlwQkMsRUFBQUEsUUFKb0I7QUFLcEJDLEVBQUFBO0FBTG9CLENBQVAsS0FNUTtBQUNyQixNQUFJLENBQUNBLElBQUksQ0FBQ0MsS0FBTCxDQUFXQyxTQUFYLENBQXFCTixPQUFyQixDQUFMLEVBQW9DO0FBQ2xDLFVBQU0sSUFBSU8sS0FBSixDQUFVLHFDQUFWLENBQU47QUFDRDs7QUFDRCxRQUFNQyxRQUFRLEdBQUcsTUFBTUosSUFBSSxDQUFDSyxHQUFMLENBQVNDLFFBQVQsQ0FBa0JDLFdBQWxCLEVBQXZCO0FBQ0EsUUFBTUMsUUFBUSxHQUFHLE1BQU0sK0JBQWlCO0FBQ3RDQyxJQUFBQSxPQUFPLEVBQUVWLFFBRDZCO0FBRXRDQyxJQUFBQTtBQUZzQyxHQUFqQixDQUF2QjtBQUlBLFFBQU1VLFVBQVUsR0FBRyxNQUFNRixRQUFRLENBQzlCRyxpQkFEc0IsQ0FDSjtBQUNqQkMsSUFBQUEsTUFBTSxFQUFFWixJQUFJLENBQUNDLEtBQUwsQ0FBV1ksU0FBWCxDQUFxQmYsT0FBckI7QUFEUyxHQURJLENBQXpCO0FBSUEsUUFBTSxDQUFDZ0IsUUFBRCxJQUFhLE1BQU1DLGVBQ3RCQyxJQURzQixDQUNqQjtBQUFFQyxJQUFBQSxHQUFHLEVBQUVQO0FBQVAsR0FEaUIsQ0FBekI7QUFHQSxRQUFNUSxRQUFRLEdBQUcsTUFBTVYsUUFBUSxDQUM1QlcsbUJBRG9CLENBQ0E7QUFDbkJQLElBQUFBLE1BQU0sRUFBRVosSUFBSSxDQUFDQyxLQUFMLENBQVdZLFNBQVgsQ0FBcUJmLE9BQXJCO0FBRFcsR0FE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Q0FBaUIvRCxXQUFqQixDQUhGLEVBSUVELE9BSkYsRUFLRW1ELE1BQU0sQ0FBQ2MsWUFBUCxDQUFvQkMsY0FBcEIsQ0FBbUNsQixRQUFuQyxFQUxGO0FBT0EsUUFBTW1CLFNBQVMsR0FBRyxNQUFNaEMsT0FBTyxDQUM1QmlDLE9BRHFCLENBRXJCQyxtQkFGcUIsQ0FHcEIzQyxZQUFZLENBQUNzQyxHQUFiLENBQWlCL0QsV0FBakIsQ0FIb0IsRUFJcEJELE9BSm9CLEVBS3BCbUQsTUFBTSxDQUFDYyxZQUFQLENBQW9CQyxjQUFwQixDQUFtQ2xCLFFBQW5DLEVBTG9CLEVBT3JCUixJQVBxQixDQU9oQjtBQUNKQyxJQUFBQSxJQUFJLEVBQUV6QyxPQURGO0FBRUowQyxJQUFBQSxHQUFHLEVBQUU7QUFGRCxHQVBnQixDQUF4QjtBQVlBLFNBQU87QUFDTDRCLElBQUFBLEVBQUUsRUFBRXBFLE9BREM7QUFFTFcsSUFBQUEsT0FBTyxFQUFFc0MsTUFBTSxDQUFDYyxZQUFQLENBQW9CQyxjQUZ4QjtBQUdMSyxJQUFBQSxJQUFJLEVBQUUxQyxLQUFLLENBQUMyQyxlQUhQO0FBSUxDLElBQUFBLFNBQVMsRUFBRTVDLEtBQUssQ0FBQzRDLFNBSlo7QUFLTEMsSUFBQUEsZ0JBQWdCLEVBQUU5RDtBQUxiLEdBQVA7QUFPRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF9kZWJ1ZyBmcm9tICdkZWJ1ZydcblxuaW1wb3J0IHtcbiAgcm9sZVRhc2sgYXMgcm9sZVRhc2tTY2hlbWEsXG4gIHBvbGljeSBhcyBwb2xpY3lTY2hlbWEsXG4gIHByb2Nlc3MgYXMgcHJvY2Vzc1NjaGVtYVxufSBmcm9tICcuLi9yZXBvJ1xuaW1wb3J0IHJlZ2lzdHJ5Q29udHJhY3QgZnJvbSAnLi4vdXRpbC9yZWdpc3RyeS1jb250cmFjdCdcbmltcG9ydCBoZXhUb0lkIGZyb20gJy4uL3V0aWwvaGV4LXRvLWlkJ1xuaW1wb3J0IGZpbmRSb2xlTWFwIGZyb20gJy4uL3V0aWwvZmluZC1yb2xlLW1hcCdcbmltcG9ydCBjcmVhdGVDb250cmFjdCBmcm9tICcuLi91dGlsL2NyZWF0ZS1jb250cmFjdCdcblxuY29uc3QgZGVidWcgPSBfZGVidWcoJ2NhdGVycGlsbGFycWw6bXV0YXRpb246cHJvY2VzcycpXG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7XG4gIGNyZWF0b3IsXG4gIGNyZWF0b3JSb2xlLFxuICBtb2RlbElkLFxuICByZWdpc3RyeSxcbiAgd2ViMyxcbn0pOiBQcm9taXNlPG9iamVjdD4gPT4ge1xuICBpZiAoIXdlYjMudXRpbHMuaXNBZGRyZXNzKGNyZWF0b3IpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYXNlIGNyZWF0b3IgaXMgbm90IGEgdmFsaWQgYWRkcmVzcycpXG4gIH1cbiAgY29uc3QgYWNjb3VudHMgPSBhd2FpdCB3ZWIzLmV0aC5wZXJzb25hbC5nZXRBY2NvdW50cygpXG4gIGNvbnN0IGNvbnRyYWN0ID0gYXdhaXQgcmVnaXN0cnlDb250cmFjdCh7XG4gICAgYWRkcmVzczogcmVnaXN0cnksXG4gICAgd2ViMyxcbiAgfSlcbiAgY29uc3Qgcm9sZVRhc2tJZCA9IGF3YWl0IGNvbnRyYWN0XG4gICAgLnRhc2tSb2xlTWFwRnJvbUlkKHtcbiAgICAgIHByb2NJZDogd2ViMy51dGlscy5mcm9tQXNjaWkobW9kZWxJZCksXG4gICAgfSlcbiAgY29uc3QgW3JvbGVUYXNrXSA9IGF3YWl0IHJvbGVUYXNrU2NoZW1hXG4gICAgLmZpbmQoeyBfaWQ6IHJvbGVUYXNrSWQgfSlcbiAgXG4gIGNvbnN0IHBvbGljeUlkID0gYXdhaXQgY29udHJhY3RcbiAgICAuYmluZGluZ1BvbGljeUZyb21JZCh7XG4gICAgICBwcm9jSWQ6IHdlYjMudXRpbHMuZnJvbUFzY2lpKG1vZGVsSWQpLFxuICAgIH0pXG4gIGNvbnN0IFtwb2xpY3ldID0gYXdhaXQgcG9saWN5U2NoZW1hXG4gICAgLmZpbmQoe1xuICAgICAgX2lkOiBwb2xpY3lJZFxuICAgIH0pXG4gIGNvbnN0IHJvbGVJbmRleE1hcCA9IGZpbmRSb2xlTWFwKHBvbGljeS5pbmRleFRvUm9sZSk7XG4gIFxuICBpZiAoIXJvbGVJbmRleE1hcC5oYXMoY3JlYXRvclJvbGUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYXNlIENyZWF0b3IgUm9sZSBOT1QgZm91bmQnKVxuICB9XG4gIFxuICBjb25zdCBbbW9kZWxdID0gYXdhaXQgcHJvY2Vzc1NjaGVtYVxuICAgIC5maW5kKHtcbiAgICAgIF9pZDogbW9kZWxJZCxcbiAgICB9KVxuICBjb25zdCBhY2Nlc3NDb250cm9sQ29udHJhY3QgPSBjcmVhdGVDb250cmFjdCh3ZWIzKShKU09OLnBhcnNlKHBvbGljeS5hY2Nlc3NDb250cm9sQWJpKSlcbiAgY29uc3QgY3JlYXRlZCA9IGF3YWl0IGFjY2Vzc0NvbnRyb2xDb250cmFjdFxuICAgIC5kZXBsb3koe1xuICAgICAgYXJndW1lbnRzOiBbXG4gICAgICAgIHJlZ2lzdHJ5LFxuICAgICAgICBwb2xpY3kuYWRkcmVzcyxcbiAgICAgICAgcm9sZVRhc2suYWRkcmVzc1xuICAgICAgXSxcbiAgICAgIGRhdGE6IFwiMHhcIiArIHBvbGljeS5hY2Nlc3NDb250cm9sQnl0ZWNvZGUsXG4gICAgfSlcbiAgICAuc2VuZCh7XG4gICAgICBmcm9tOiBjcmVhdG9yLFxuICAgICAgZ2FzOiA0NzAwMDAwLFxuICAgIH0pXG4gIGNvbnNvbGUubG9nKCdhY2Nlc3MgY29udHJvbCBjb250cmFjdCBjcmVhdGVkJywgY3JlYXRlZC5hZGRyZXNzKVxuICBjb25zdCBpbnN0YW5jZSA9IGF3YWl0IGNvbnRyYWN0XG4gICAgLm5ld0J1bmRsZUluc3RhbmNlRm9yKHtcbiAgICAgIGJ1bmRsZUlkOiB3ZWIzLnV0aWxzLmZyb21Bc2NpaShtb2RlbC5faWQudG9TdHJpbmcoKSksXG4gICAgICBwYXJlbnQ6ICcweDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAnLFxuICAgICAgcG9saWN5T3BBZGRyOiBjcmVhdGVkLmFkZHJlc3MsXG4gICAgfSlcbiAgICAoe1xuICAgICAgZnJvbTogY3JlYXRvciwgLy9hY2NvdW50c1swXSxcbiAgICAgIGdhczogNDUwMDAwMCxcbiAgICB9KVxuICBkZWJ1Zyh7IGluc3RhbmNlIH0pXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG5ldyBQcm9taXNlKFxuICAgIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY29udHJhY3RcbiAgICAuZXZlbnRzXG4gICAgLk5ld0luc3RhbmNlQ3JlYXRlZEZvcih7XG4gICAgICBmcm9tQmxvY2s6IGluc3RhbmNlLmJsb2NrTnVtYmVyLFxuICAgIH0pXG4gICAgLm9uKFxuICAgICAgJ2RhdGEnLFxuICAgICAgZSA9PiB7XG4gICAgICAgIGlmIChlLnRyYW5zYWN0aW9uSGFzaCA9PT0gaW5zdGFuY2UudHJhbnNhY3Rpb25IYXNoKSB7XG4gICAgICAgICAgZXZlbnQucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnKVxuICAgICAgICAgIGV2ZW50LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicpXG4gICAgICAgICAgcmVzb2x2ZShlKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIClcbiAgICAub24oXG4gICAgICAnZXJyb3InLFxuICAgICAgZSA9PiB7XG4gICAgICAgIGV2ZW50LnJlbW92ZUxpc3RlbmVyKCdkYXRhJylcbiAgICAgICAgZXZlbnQucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJylcbiAgICAgICAgcmVqZWN0KGUpXG4gICAgICB9LFxuICAgICk7XG4gIFxuXG4gICAgfVxuICApXG4gIGNvbnNvbGUubG9nKFxuICAgICdnb3QgdG8gbm9taW5hdGVkLi4nLFxuICAgIGNyZWF0b3JSb2xlLFxuICAgIHJvbGVJbmRleE1hcC5nZXQoY3JlYXRvclJvbGUpLFxuICAgIGNyZWF0b3IsXG4gICAgcmVzdWx0LnJldHVyblZhbHVlcy5wcm9jZXNzQWRkcmVzcy50b1N0cmluZygpXG4gIClcbiAgY29uc3Qgbm9taW5hdGVkID0gYXdhaXQgY3JlYXRlZFxuICAgIC5tZXRob2RzXG4gICAgLm5vbWluYXRlQ2FzZUNyZWF0b3IoXG4gICAgICByb2xlSW5kZXhNYXAuZ2V0KGNyZWF0b3JSb2xlKSxcbiAgICAgIGNyZWF0b3IsXG4gICAgICByZXN1bHQucmV0dXJuVmFsdWVzLnByb2Nlc3NBZGRyZXNzLnRvU3RyaW5nKCksXG4gICAgKVxuICAgIC5zZW5kKHtcbiAgICAgIGZyb206IGNyZWF0b3IsXG4gICAgICBnYXM6IDQ3MDAwMDAsXG4gICAgfSlcbiAgXG4gIHJldHVybiB7XG4gICAgaWQ6IG1vZGVsSWQsXG4gICAgYWRkcmVzczogcmVzdWx0LnJldHVyblZhbHVlcy5wcm9jZXNzQWRkcmVzcyxcbiAgICBuYW1lOiBtb2RlbC5yb290UHJvY2Vzc05hbWUsXG4gICAgYnBtbk1vZGVsOiBtb2RlbC5icG1uTW9kZWwsXG4gICAgcmVnaXN0cnlDb250cmFjdDogY29udHJhY3QgICAgICAgICAgICAgICAgXG4gIH1cbn0iXX0=