"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _repo = require("../../repo");

var _createContract = _interopRequireDefault(require("../../util/create-contract"));

var _debug2 = _interopRequireDefault(require("debug"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debug = (0, _debug2.default)('caterpillarql:process-contract:instance-state');

const findParameters = (contractAbi, functionName) => {
  let jsonAbi = JSON.parse(contractAbi);
  let candidates = [];
  jsonAbi.forEach(element => {
    if (element.name === functionName) {
      candidates = element.inputs;
    }
  });
  let res = [];
  candidates.forEach(element => {
    if (element.name && element.name !== 'workitemId') res.push(element);
  });
  return res;
};

var _default = ({
  web3,
  bpmnModel,
  registryContract
}) => async contractAddress => {
  debug({
    contractAddress
  }); // the model id

  const bundleId = await registryContract.bundleFor({
    instance: contractAddress
  });
  const [{
    abi,
    indexToElement,
    worklistAbi
  }] = await _repo.process.find({
    _id: bundleId
  }); // this is the contract for this instance

  const instanceContract = (0, _createContract.default)(web3)(JSON.parse(abi), contractAddress); // this is the address of the worklist contract for the instance

  const worklistAddress = await instanceContract.methods.getWorklistAddress.call();
  debug({
    worklistAddress
  }); // what does it mean when it is 0??

  const worklistContract = worklistAddress.toString() !== '0x0000000000000000000000000000000000000000' && (0, _createContract.default)(web3)(JSON.parse(worklistAbi), worklistAddress);

  if (!worklistContract) {
    return null;
  }

  const startedActivities = web3.utils.toBN((await instanceContract.methods.startedActivities.call())).toString(2).split('').reverse();
  debug({
    startedActivities
  });
  const s = await Promise.all(startedActivities.map((state, index) => ({
    index,
    state
  })).filter(({
    state,
    index
  }) => state === '1' && indexToElement[index].type === 'Workitem').map(({
    state,
    index
  }) => worklistContract.methods.workItemsFor(index, contractAddress).call().then(async x => ({
    index,
    refs: await Promise.all(web3.utils.toBN(x).toString(2).split('').reverse().map((val, index) => ({
      index,
      val
    })).filter(({
      val
    }) => val === '1').map(({
      index
    }) => worklistContract.methods.processInstanceFor(index).call().then(processAddress => ({
      index,
      processAddress,
      worklistAddress
    }))))
  }))));
  debug(JSON.stringify(s, null, 2));
  return {
    bpmn: bpmnModel,
    workItems: s.map(({
      index,
      refs
    }) => ({
      elementId: indexToElement[index].id,
      elementName: indexToElement[index].name,
      input: findParameters(worklistAbi, indexToElement[index].name),
      refs,
      worklistAddress
    }))
  };
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2FwcC9yZXNvbHZlcnMvcHJvY2Vzcy1jb250cmFjdC9pbnN0YW5jZS1zdGF0ZS9pbmRleC50cyJdLCJuYW1lcyI6WyJkZWJ1ZyIsImZpbmRQYXJhbWV0ZXJzIiwiY29udHJhY3RBYmkiLCJmdW5jdGlvbk5hbWUiLCJqc29uQWJpIiwiSlNPTiIsInBhcnNlIiwiY2FuZGlkYXRlcyIsImZvckVhY2giLCJlbGVtZW50IiwibmFtZSIsImlucHV0cyIsInJlcyIsInB1c2giLCJ3ZWIzIiwiYnBtbk1vZGVsIiwicmVnaXN0cnlDb250cmFjdCIsImNvbnRyYWN0QWRkcmVzcyIsImJ1bmRsZUlkIiwiYnVuZGxlRm9yIiwiaW5zdGFuY2UiLCJhYmkiLCJpbmRleFRvRWxlbWVudCIsIndvcmtsaXN0QWJpIiwicHJvY2VzcyIsImZpbmQiLCJfaWQiLCJpbnN0YW5jZUNvbnRyYWN0Iiwid29ya2xpc3RBZGRyZXNzIiwibWV0aG9kcyIsImdldFdvcmtsaXN0QWRkcmVzcyIsImNhbGwiLCJ3b3JrbGlzdENvbnRyYWN0IiwidG9TdHJpbmciLCJzdGFydGVkQWN0aXZpdGllcyIsInV0aWxzIiwidG9CTiIsInNwbGl0IiwicmV2ZXJzZSIsInMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwic3RhdGUiLCJpbmRleCIsImZpbHRlciIsInR5cGUiLCJ3b3JrSXRlbXNGb3IiLCJ0aGVuIiwieCIsInJlZnMiLCJ2YWwiLCJwcm9jZXNzSW5zdGFuY2VGb3IiLCJwcm9jZXNzQWRkcmVzcyIsInN0cmluZ2lmeSIsImJwbW4iLCJ3b3JrSXRlbXMiLCJlbGVtZW50SWQiLCJpZCIsImVsZW1lbnROYW1lIiwiaW5wdXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLEtBQUssR0FBRyxxQkFBTywrQ0FBUCxDQUFkOztBQUVBLE1BQU1DLGNBQWMsR0FBRyxDQUFDQyxXQUFELEVBQWNDLFlBQWQsS0FBK0I7QUFDcEQsTUFBSUMsT0FBTyxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0osV0FBWCxDQUFkO0FBQ0EsTUFBSUssVUFBVSxHQUFHLEVBQWpCO0FBQ0FILEVBQUFBLE9BQU8sQ0FBQ0ksT0FBUixDQUFnQkMsT0FBTyxJQUFJO0FBQ3ZCLFFBQUlBLE9BQU8sQ0FBQ0MsSUFBUixLQUFpQlAsWUFBckIsRUFBbUM7QUFDL0JJLE1BQUFBLFVBQVUsR0FBR0UsT0FBTyxDQUFDRSxNQUFyQjtBQUNIO0FBQ0osR0FKRDtBQUtBLE1BQUlDLEdBQUcsR0FBRyxFQUFWO0FBQ0FMLEVBQUFBLFVBQVUsQ0FBQ0MsT0FBWCxDQUFtQkMsT0FBTyxJQUFJO0FBQzFCLFFBQUlBLE9BQU8sQ0FBQ0MsSUFBUixJQUFnQkQsT0FBTyxDQUFDQyxJQUFSLEtBQWlCLFlBQXJDLEVBQ0lFLEdBQUcsQ0FBQ0MsSUFBSixDQUFTSixPQUFUO0FBQ1AsR0FIRDtBQUlBLFNBQU9HLEdBQVA7QUFDRCxDQWREOztlQWlCZSxDQUNiO0FBQ0VFLEVBQUFBLElBREY7QUFFRUMsRUFBQUEsU0FGRjtBQUdFQyxFQUFBQTtBQUhGLENBRGEsS0FVQSxNQUNiQyxlQURhLElBRUk7QUFDakJqQixFQUFBQSxLQUFLLENBQUM7QUFBRWlCLElBQUFBO0FBQUYsR0FBRCxDQUFMLENBRGlCLENBR2pCOztBQUNBLFFBQU1DLFFBQVEsR0FBRyxNQUFNRixnQkFBZ0IsQ0FDcENHLFNBRG9CLENBQ1Y7QUFBRUMsSUFBQUEsUUFBUSxFQUFFSDtBQUFaLEdBRFUsQ0FBdkI7QUFHQSxRQUFNLENBQUM7QUFDTEksSUFBQUEsR0FESztBQUVMQyxJQUFBQSxjQUZLO0FBR0xDLElBQUFBO0FBSEssR0FBRCxJQUlELE1BQU1DLGNBQ1JDLElBRFEsQ0FDSDtBQUFFQyxJQUFBQSxHQUFHLEVBQUVSO0FBQVAsR0FERyxDQUpYLENBUGlCLENBY2pCOztBQUNBLFFBQU1TLGdCQUFnQixHQUFHLDZCQUFlYixJQUFmLEVBQXFCVCxJQUFJLENBQUNDLEtBQUwsQ0FBV2UsR0FBWCxDQUFyQixFQUFzQ0osZUFBdEMsQ0FBekIsQ0FmaUIsQ0FpQmpCOztBQUNBLFFBQU1XLGVBQWUsR0FBRyxNQUFNRCxnQkFBZ0IsQ0FDM0NFLE9BRDJCLENBRTNCQyxrQkFGMkIsQ0FFUkMsSUFGUSxFQUE5QjtBQUdBL0IsRUFBQUEsS0FBSyxDQUFDO0FBQUU0QixJQUFBQTtBQUFGLEdBQUQsQ0FBTCxDQXJCaUIsQ0FzQmpCOztBQUNBLFFBQU1JLGdCQUFnQixHQUFHSixlQUFlLENBQUNLLFFBQWhCLE9BQStCLDRDQUEvQixJQUN2Qiw2QkFBZW5CLElBQWYsRUFBcUJULElBQUksQ0FBQ0MsS0FBTCxDQUFXaUIsV0FBWCxDQUFyQixFQUE4Q0ssZUFBOUMsQ0FERjs7QUFFQSxNQUFJLENBQUNJLGdCQUFMLEVBQXVCO0FBQ3JCLFdBQU8sSUFBUDtBQUNEOztBQUNELFFBQU1FLGlCQUFpQixHQUFHcEIsSUFBSSxDQUFDcUIsS0FBTCxDQUFXQyxJQUFYLEVBQ3hCLE1BQU1ULGdCQUFnQixDQUNuQkUsT0FERyxDQUVISyxpQkFGRyxDQUdISCxJQUhHLEVBRGtCLEdBS3hCRSxRQUx3QixDQUtmLENBTGUsRUFLWkksS0FMWSxDQUtOLEVBTE0sRUFLRkMsT0FMRSxFQUExQjtBQU9BdEMsRUFBQUEsS0FBSyxDQUFDO0FBQUVrQyxJQUFBQTtBQUFGLEdBQUQsQ0FBTDtBQUVBLFFBQU1LLENBQUMsR0FBRyxNQUFNQyxPQUFPLENBQUNDLEdBQVIsQ0FDZFAsaUJBQWlCLENBQ2RRLEdBREgsQ0FFSSxDQUFDQyxLQUFELEVBQVFDLEtBQVIsTUFBbUI7QUFDakJBLElBQUFBLEtBRGlCO0FBRWpCRCxJQUFBQTtBQUZpQixHQUFuQixDQUZKLEVBT0dFLE1BUEgsQ0FRSSxDQUFDO0FBQUVGLElBQUFBLEtBQUY7QUFBU0MsSUFBQUE7QUFBVCxHQUFELEtBQ0VELEtBQUssS0FBSyxHQUFWLElBQ0VyQixjQUFjLENBQUNzQixLQUFELENBQWQsQ0FBc0JFLElBQXRCLEtBQStCLFVBVnZDLEVBWUdKLEdBWkgsQ0FhSSxDQUFDO0FBQ0NDLElBQUFBLEtBREQ7QUFFQ0MsSUFBQUE7QUFGRCxHQUFELEtBR01aLGdCQUFnQixDQUNuQkgsT0FERyxDQUVIa0IsWUFGRyxDQUVVSCxLQUZWLEVBRWlCM0IsZUFGakIsRUFHSGMsSUFIRyxHQUlIaUIsSUFKRyxDQUtGLE1BQU9DLENBQVAsS0FBNEI7QUFDMUJMLElBQUFBLEtBRDBCO0FBRTFCTSxJQUFBQSxJQUFJLEVBQUUsTUFBTVYsT0FBTyxDQUFDQyxHQUFSLENBQ1YzQixJQUFJLENBQUNxQixLQUFMLENBQVdDLElBQVgsQ0FBZ0JhLENBQWhCLEVBQW1CaEIsUUFBbkIsQ0FBNEIsQ0FBNUIsRUFBK0JJLEtBQS9CLENBQXFDLEVBQXJDLEVBQXlDQyxPQUF6QyxHQUNHSSxHQURILENBRUksQ0FBQ1MsR0FBRCxFQUFNUCxLQUFOLE1BQWlCO0FBQ2ZBLE1BQUFBLEtBRGU7QUFFZk8sTUFBQUE7QUFGZSxLQUFqQixDQUZKLEVBT0dOLE1BUEgsQ0FRSSxDQUFDO0FBQUVNLE1BQUFBO0FBQUYsS0FBRCxLQUFhQSxHQUFHLEtBQUssR0FSekIsRUFVR1QsR0FWSCxDQVdJLENBQUM7QUFDQ0UsTUFBQUE7QUFERCxLQUFELEtBRU1aLGdCQUFnQixDQUNuQkgsT0FERyxDQUNLdUIsa0JBREwsQ0FDd0JSLEtBRHhCLEVBRUhiLElBRkcsR0FHSGlCLElBSEcsQ0FJRkssY0FBYyxLQUFLO0FBQ2pCVCxNQUFBQSxLQURpQjtBQUVqQlMsTUFBQUEsY0FGaUI7QUFHakJ6QixNQUFBQTtBQUhpQixLQUFMLENBSlosQ0FiVixDQURVO0FBRmMsR0FBNUIsQ0FMRSxDQWhCVixDQURjLENBQWhCO0FBc0RBNUIsRUFBQUEsS0FBSyxDQUFDSyxJQUFJLENBQUNpRCxTQUFMLENBQWVmLENBQWYsRUFBa0IsSUFBbEIsRUFBdUIsQ0FBdkIsQ0FBRCxDQUFMO0FBQ0EsU0FBTztBQUNMZ0IsSUFBQUEsSUFBSSxFQUFFeEMsU0FERDtBQUVMeUMsSUFBQUEsU0FBUyxFQUFFakIsQ0FBQyxDQUNURyxHQURRLENBRVAsQ0FBQztBQUFFRSxNQUFBQSxLQUFGO0FBQVNNLE1BQUFBO0FBQVQsS0FBRCxNQUFzQjtBQUNwQk8sTUFBQUEsU0FBUyxFQUFFbkMsY0FBYyxDQUFDc0IsS0FBRCxDQUFkLENBQXNCYyxFQURiO0FBRXBCQyxNQUFBQSxXQUFXLEVBQUVyQyxjQUFjLENBQUNzQixLQUFELENBQWQsQ0FBc0JsQyxJQUZmO0FBR3BCa0QsTUFBQUEsS0FBSyxFQUFFM0QsY0FBYyxDQUFDc0IsV0FBRCxFQUFjRCxjQUFjLENBQUNzQixLQUFELENBQWQsQ0FBc0JsQyxJQUFwQyxDQUhEO0FBSXBCd0MsTUFBQUEsSUFKb0I7QUFLcEJ0QixNQUFBQTtBQUxvQixLQUF0QixDQUZPO0FBRk4sR0FBUDtBQWNELEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV2ViMyBmcm9tICd3ZWIzJ1xuaW1wb3J0IHsgcHJvY2VzcyB9IGZyb20gJy4uLy4uL3JlcG8nXG5pbXBvcnQgY3JlYXRlQ29udHJhY3QgZnJvbSAnLi4vLi4vdXRpbC9jcmVhdGUtY29udHJhY3QnXG5pbXBvcnQgX2RlYnVnIGZyb20gJ2RlYnVnJ1xuXG5jb25zdCBkZWJ1ZyA9IF9kZWJ1ZygnY2F0ZXJwaWxsYXJxbDpwcm9jZXNzLWNvbnRyYWN0Omluc3RhbmNlLXN0YXRlJylcblxuY29uc3QgZmluZFBhcmFtZXRlcnMgPSAoY29udHJhY3RBYmksIGZ1bmN0aW9uTmFtZSkgPT4ge1xuICBsZXQganNvbkFiaSA9IEpTT04ucGFyc2UoY29udHJhY3RBYmkpO1xuICBsZXQgY2FuZGlkYXRlcyA9IFtdO1xuICBqc29uQWJpLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICBpZiAoZWxlbWVudC5uYW1lID09PSBmdW5jdGlvbk5hbWUpIHtcbiAgICAgICAgICBjYW5kaWRhdGVzID0gZWxlbWVudC5pbnB1dHM7XG4gICAgICB9XG4gIH0pO1xuICBsZXQgcmVzID0gW107XG4gIGNhbmRpZGF0ZXMuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgIGlmIChlbGVtZW50Lm5hbWUgJiYgZWxlbWVudC5uYW1lICE9PSAnd29ya2l0ZW1JZCcpXG4gICAgICAgICAgcmVzLnB1c2goZWxlbWVudCk7XG4gIH0pO1xuICByZXR1cm4gcmVzO1xufTtcblxuXG5leHBvcnQgZGVmYXVsdCAoXG4gIHtcbiAgICB3ZWIzLFxuICAgIGJwbW5Nb2RlbCxcbiAgICByZWdpc3RyeUNvbnRyYWN0LFxuICB9IDoge1xuICAgIHdlYjM6IFdlYjMsXG4gICAgYnBtbk1vZGVsOiBzdHJpbmcsXG4gICAgcmVnaXN0cnlDb250cmFjdDogaW1wb3J0KCdjYXRlcnBpbGxhci1saWInKS5SZWdpc3RyeUNvbnRyYWN0LFxuICB9XG4pOiBGdW5jdGlvbiA9PiBhc3luYyAoXG4gIGNvbnRyYWN0QWRkcmVzcyxcbik6IFByb21pc2U8YW55PiA9PiB7XG4gIGRlYnVnKHsgY29udHJhY3RBZGRyZXNzIH0pXG5cbiAgLy8gdGhlIG1vZGVsIGlkXG4gIGNvbnN0IGJ1bmRsZUlkID0gYXdhaXQgcmVnaXN0cnlDb250cmFjdFxuICAgIC5idW5kbGVGb3IoeyBpbnN0YW5jZTogY29udHJhY3RBZGRyZXNzIH0pXG5cbiAgY29uc3QgW3tcbiAgICBhYmksXG4gICAgaW5kZXhUb0VsZW1lbnQsXG4gICAgd29ya2xpc3RBYmksXG4gIH1dID0gYXdhaXQgcHJvY2Vzc1xuICAgIC5maW5kKHsgX2lkOiBidW5kbGVJZCB9KVxuICBcbiAgLy8gdGhpcyBpcyB0aGUgY29udHJhY3QgZm9yIHRoaXMgaW5zdGFuY2VcbiAgY29uc3QgaW5zdGFuY2VDb250cmFjdCA9IGNyZWF0ZUNvbnRyYWN0KHdlYjMpKEpTT04ucGFyc2UoYWJpKSwgY29udHJhY3RBZGRyZXNzKVxuXG4gIC8vIHRoaXMgaXMgdGhlIGFkZHJlc3Mgb2YgdGhlIHdvcmtsaXN0IGNvbnRyYWN0IGZvciB0aGUgaW5zdGFuY2VcbiAgY29uc3Qgd29ya2xpc3RBZGRyZXNzID0gYXdhaXQgaW5zdGFuY2VDb250cmFjdFxuICAgIC5tZXRob2RzXG4gICAgLmdldFdvcmtsaXN0QWRkcmVzcy5jYWxsKClcbiAgZGVidWcoeyB3b3JrbGlzdEFkZHJlc3MgfSlcbiAgLy8gd2hhdCBkb2VzIGl0IG1lYW4gd2hlbiBpdCBpcyAwPz9cbiAgY29uc3Qgd29ya2xpc3RDb250cmFjdCA9IHdvcmtsaXN0QWRkcmVzcy50b1N0cmluZygpICE9PSAnMHgwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwJyAmJlxuICAgIGNyZWF0ZUNvbnRyYWN0KHdlYjMpKEpTT04ucGFyc2Uod29ya2xpc3RBYmkpLCB3b3JrbGlzdEFkZHJlc3MpXG4gIGlmICghd29ya2xpc3RDb250cmFjdCkge1xuICAgIHJldHVybiBudWxsXG4gIH1cbiAgY29uc3Qgc3RhcnRlZEFjdGl2aXRpZXMgPSB3ZWIzLnV0aWxzLnRvQk4oXG4gICAgYXdhaXQgaW5zdGFuY2VDb250cmFjdFxuICAgICAgLm1ldGhvZHNcbiAgICAgIC5zdGFydGVkQWN0aXZpdGllc1xuICAgICAgLmNhbGwoKVxuICApLnRvU3RyaW5nKDIpLnNwbGl0KCcnKS5yZXZlcnNlKClcblxuICBkZWJ1Zyh7IHN0YXJ0ZWRBY3Rpdml0aWVzIH0pXG5cbiAgY29uc3QgcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgIHN0YXJ0ZWRBY3Rpdml0aWVzXG4gICAgICAubWFwKFxuICAgICAgICAoc3RhdGUsIGluZGV4KSA9PiAoe1xuICAgICAgICAgIGluZGV4LFxuICAgICAgICAgIHN0YXRlLFxuICAgICAgICB9KVxuICAgICAgKVxuICAgICAgLmZpbHRlcihcbiAgICAgICAgKHsgc3RhdGUsIGluZGV4IH0pID0+XG4gICAgICAgICAgc3RhdGUgPT09ICcxJyAmJlxuICAgICAgICAgICAgaW5kZXhUb0VsZW1lbnRbaW5kZXhdLnR5cGUgPT09ICdXb3JraXRlbSdcbiAgICAgIClcbiAgICAgIC5tYXAoXG4gICAgICAgICh7XG4gICAgICAgICAgc3RhdGUsXG4gICAgICAgICAgaW5kZXgsXG4gICAgICAgIH0pID0+IHdvcmtsaXN0Q29udHJhY3RcbiAgICAgICAgICAubWV0aG9kc1xuICAgICAgICAgIC53b3JrSXRlbXNGb3IoaW5kZXgsIGNvbnRyYWN0QWRkcmVzcylcbiAgICAgICAgICAuY2FsbCgpXG4gICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICBhc3luYyAoeCk6IFByb21pc2U8YW55PiA9PiAoe1xuICAgICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgICAgcmVmczogYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICAgICAgd2ViMy51dGlscy50b0JOKHgpLnRvU3RyaW5nKDIpLnNwbGl0KCcnKS5yZXZlcnNlKClcbiAgICAgICAgICAgICAgICAgIC5tYXAoXG4gICAgICAgICAgICAgICAgICAgICh2YWwsIGluZGV4KSA9PiAoe1xuICAgICAgICAgICAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgIHZhbCxcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgIC5maWx0ZXIoXG4gICAgICAgICAgICAgICAgICAgICh7IHZhbCB9KSA9PiB2YWwgPT09ICcxJ1xuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgLm1hcChcbiAgICAgICAgICAgICAgICAgICAgKHtcbiAgICAgICAgICAgICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgICAgICAgICAgfSkgPT4gd29ya2xpc3RDb250cmFjdFxuICAgICAgICAgICAgICAgICAgICAgIC5tZXRob2RzLnByb2Nlc3NJbnN0YW5jZUZvcihpbmRleClcbiAgICAgICAgICAgICAgICAgICAgICAuY2FsbCgpXG4gICAgICAgICAgICAgICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzQWRkcmVzcyA9PiAoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc0FkZHJlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtsaXN0QWRkcmVzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIClcbiAgICAgICksXG4gIClcbiAgZGVidWcoSlNPTi5zdHJpbmdpZnkocywgbnVsbCwyKSlcbiAgcmV0dXJuIHtcbiAgICBicG1uOiBicG1uTW9kZWwsXG4gICAgd29ya0l0ZW1zOiBzXG4gICAgICAubWFwKFxuICAgICAgICAoeyBpbmRleCwgcmVmcyB9KSA9PiAoe1xuICAgICAgICAgIGVsZW1lbnRJZDogaW5kZXhUb0VsZW1lbnRbaW5kZXhdLmlkLFxuICAgICAgICAgIGVsZW1lbnROYW1lOiBpbmRleFRvRWxlbWVudFtpbmRleF0ubmFtZSxcbiAgICAgICAgICBpbnB1dDogZmluZFBhcmFtZXRlcnMod29ya2xpc3RBYmksIGluZGV4VG9FbGVtZW50W2luZGV4XS5uYW1lKSxcbiAgICAgICAgICByZWZzLFxuICAgICAgICAgIHdvcmtsaXN0QWRkcmVzcyxcbiAgICAgICAgfSlcbiAgICAgIClcblxuICB9XG59XG4iXX0=